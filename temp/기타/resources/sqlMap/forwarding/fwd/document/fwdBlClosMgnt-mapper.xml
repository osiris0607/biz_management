<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fwd.document.fwdBlClosMgnt">
    <!-- 해상HBL LIST조회 -->
    <select id="selectSeaHblList" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectSeaHblList */
	     SELECT 'N'  AS CHK
	           ,'N'  AS CM_MAIL_CHK
	           /*,FC_IS_GET_SALES_RCGN(MAIN.SO_NO, '', 'FLAG') AS REVN_RCGN_CD*/           
	           ,'' AS REVN_RCGN_CD
	           /*,FC_IS_GET_SALES_RCGN(MAIN.SO_NO, '', '') AS REVN_RCGN_IMG*/
	           ,'' AS REVN_RCGN_IMG
	           ,MAIN.ORD_TYPE_CD
	           ,MAIN.SMT_NO
	           ,MAIN.EO_NO
	           ,MAIN.BL_NO
	           ,MAIN.SR_NO
	           ,MAIN.MBL_NO
	           ,MAIN.IMP_BL_SPLIT_ADJ_YN
	           ,MAIN.WGT_CLOS_YN
	           ,MAIN.ONBR_CLOS_YN
	           ,MAIN.ARR_CLOS_YN
	           ,MAIN.EXP_CC_RQST_YN
	           ,MAIN.IMP_CC_RQST_YN
	           ,MAIN.BL_SPR_CD
	           ,CASE WHEN MAIN.NON_EXCT_BL_YN = 'Y' THEN 'S.DBL' ELSE (SELECT X1.DTL_CD_NM  
                                                                         FROM TB_COM_ETC_CD  X1  
                                                                        WHERE X1.CLAS_CD = '0055'  
                                                                          AND X1.DTL_CD  = MAIN.BL_SPR_CD 
                                                                          AND X1.USE_YN  = 'Y') END AS BL_SPR_CD_NM
               ,MAIN.EXCT_SPR_CD
	           ,MAIN.LADG_TYPE_CD
	           ,(SELECT X1.DTL_CD_NM  
	               FROM TB_COM_ETC_CD  X1  
	              WHERE X1.CLAS_CD = '0064'  
	                AND X1.DTL_CD  = MAIN.LADG_TYPE_CD 
	                AND X1.USE_YN  = 'Y') AS LADG_TYPE_CD_NM
	           ,MAIN.ONBR_YMD
	           ,MAIN.ARR_YMD
	           ,(SELECT CASE WHEN MAIN.ARR_YMD != B.ARR_YMD THEN 'Y' ELSE 'N' END
	               FROM TB_FWD_BL_LOG B
	              WHERE B.BL_ID = MAIN.BL_ID
	                AND LOG_SEQ = (SELECT MAX(LOG_SEQ)
	                                 FROM TB_FWD_BL_LOG LOG
	                                WHERE LOG.BL_ID = MAIN.BL_ID)) AS ARR_UPD
	           ,MAIN.CARR_GRP_CD
	           ,MAIN.CARR_NM
	           ,MAIN.CARR_CD
	           ,(SELECT X1.BIZPTNR_ENG_NM
	               FROM TB_COM_BIZPTNR X1 
	              WHERE X1.BIZPTNR_CD = MAIN.CARR_CD ) AS CARR_CD_NM
	           ,MAIN.AGNT_CD AS AGNT_CD
	           ,(SELECT X1.BIZPTNR_ENG_NM
	               FROM TB_COM_BIZPTNR X1 
	              WHERE X1.BIZPTNR_CD = MAIN.AGNT_CD ) AS AGNT_CD_NM
	           ,IFNULL((SELECT X1.BIZPTNR_ENG_NM
	                      FROM TB_COM_BIZPTNR X1 
	                     WHERE X1.BIZPTNR_CD = MAIN.CARR_CD), '') AS CARR_LOCAL_NM
	           ,MAIN.FLT_VSL_NM
	           ,MAIN.FLT_VSL_NM AS PRE_FLT_VSL_NM
               ,(SELECT S.INTG_ADDR
                   FROM TB_FWD_INTG_ADDR S
                  WHERE S.DEL_YN = 'N'
                    AND S.ADDR_SPR_CD = 'BS'
                    AND S.INTG_KEY_ID = MAIN.BL_ID ) AS SHIPPER_ADDR
               ,(SELECT S.INTG_ADDR
                   FROM TB_FWD_INTG_ADDR S
                  WHERE S.DEL_YN = 'N'
                    AND S.ADDR_SPR_CD = 'BC'
                    AND S.INTG_KEY_ID = MAIN.BL_ID ) AS CONSIGNEE_ADDR
               ,(SELECT S.INTG_ADDR
                   FROM TB_FWD_INTG_ADDR S
                  WHERE S.DEL_YN = 'N'
                    AND S.ADDR_SPR_CD = 'BN'
                    AND S.INTG_KEY_ID = MAIN.BL_ID ) AS NOTIFY_ADDR
               ,(SELECT S.INTG_ADDR
                   FROM TB_FWD_INTG_ADDR S
                  WHERE S.DEL_YN = 'N'
                    AND S.ADDR_SPR_CD = 'BP'
                    AND S.INTG_KEY_ID = MAIN.BL_ID ) AS PNTR_ADDR
	           ,MAIN.VOYAGE
	           ,MAIN.POR_CD
	           ,MAIN.POR_NM
	           ,MAIN.POL_CD
	           ,MAIN.POL_NM
	           ,MAIN.POD_CD
	           ,MAIN.POD_NM
	           ,MAIN.PDEL_CD
	           ,MAIN.PDEL_NM
	           ,MAIN.FDEST_CD
	           ,MAIN.FDEST_NM
	           ,MAIN.SHPP_CD
	           ,MAIN.CNEE_CD
	           ,MAIN.NTPR_CD
	           ,MAIN.SHPP_NM
	           ,IFNULL((SELECT X1.BIZPTNR_ENG_NM
	                      FROM TB_COM_BIZPTNR X1 
	                     WHERE X1.BIZPTNR_CD = MAIN.SHPP_CD), '')   AS SHPP_LOCAL_NM
	           ,MAIN.CNEE_NM
               ,IFNULL((SELECT X1.BIZPTNR_ENG_NM
                          FROM TB_COM_BIZPTNR X1 
                         WHERE X1.BIZPTNR_CD = MAIN.CNEE_CD), '')   AS CNEE_LOCAL_NM
	           ,MAIN.NTPR_NM
	           ,MAIN.SELL_GWT
	           ,MAIN.SELL_CBM
	           ,MAIN.PKG_QTY
	           ,MAIN.PKG_UNIT_CD
	           ,(SELECT X1.DTL_CD_NM  
	               FROM TB_COM_ETC_CD  X1  
	              WHERE X1.CLAS_CD = '0134'  
	                AND X1.DTL_CD  = MAIN.PKG_UNIT_CD 
	                AND X1.USE_YN  ='Y') AS PKG_UNIT_CD_NM
	           ,MAIN.CARGO_TYPE_CD
	           ,(SELECT X1.DTL_CD_NM  
	               FROM TB_COM_ETC_CD  X1  
	              WHERE X1.CLAS_CD = '0077'  
	                AND X1.DTL_CD  = MAIN.CARGO_TYPE_CD 
	                AND X1.USE_YN  ='Y') AS CARGO_TYPE_CD_NM
	           ,MAIN.RPRS_REF_NO
	           ,(CASE WHEN IFNULL(MAIN.CONF_REQD_YN, 'N') = 'Y' THEN IFNULL(MAIN.CONF_YN, 'N')
	                  ELSE 'X' 
	                  END) AS ROLE_CONF_YN
	           ,(SELECT (SELECT X1.CORP_ACRN_NM5
	                       FROM TB_COM_CORP X1
	                      WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
	               FROM TB_SMT_INTG_TASK_DEPT T
	              WHERE MAIN.EO_NO = T.EO_NO
	                AND T.TASK_SPR_CD = 'EXP'
	                AND T.DEL_YN = 'N'
	              LIMIT 1) AS ORGIN_PTNR
	           ,(SELECT (SELECT X1.CORP_ACRN_NM5
	                       FROM TB_COM_CORP X1
	                      WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
	               FROM TB_SMT_INTG_TASK_DEPT T
	              WHERE MAIN.EO_NO = T.EO_NO
	                AND T.TASK_SPR_CD = 'TRD'
	                AND T.DEL_YN = 'N'
	              LIMIT  1) AS THIRD_PTNR
	           ,(SELECT (SELECT X1.CORP_ACRN_NM5
	                       FROM TB_COM_CORP X1
	                      WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
	               FROM TB_SMT_INTG_TASK_DEPT T
	              WHERE MAIN.EO_NO = T.EO_NO
	                AND T.TASK_SPR_CD = 'IMP'
	                AND T.DEL_YN = 'N'
	              LIMIT  1) AS ARR_PTNR
               ,(CASE WHEN SUBSTR(CASE WHEN MAIN.BL_ID IS NULL THEN (SELECT MAX(X1.STATUS)
                                                                        FROM (
                                                                              SELECT STATUS
                                                                                FROM NFINF.TB_FWD_INT5040 AX
                                                                               WHERE AX.HBL_NO  = MAIN.BL_NO
                                                                                 AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                       FROM NFINF.TB_FWD_INT5040
                                                                                                      WHERE HBL_NO = AX.HBL_NO )
                                                                               UNION ALL
                                                                              SELECT SUBSTR(STATUS,2,2) AS STATUS
                                                                                FROM NFINF.TB_FWD_INT5940 AX
                                                                               WHERE AX.HBL_NO  = MAIN.BL_NO
                                                                                 AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                       FROM NFINF.TB_FWD_INT5940
                                                                                                      WHERE HBL_NO = AX.HBL_NO )) X1)
                                        ELSE (SELECT MAX(X1.STATUS)
                                                FROM (
                                                      SELECT IFNULL(BX.STAT_CD, AX.STATUS)   AS STATUS
                                                        FROM NFINF.TB_FWD_INT5040 AX
                                             LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG BX
                                                          ON AX.HBL_NO = BX.BL_NO
                                                       WHERE AX.HBL_NO = MAIN.BL_NO
                                                         AND BX.BL_ID = MAIN.BL_ID
                                                         AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                             FROM NFINF.TB_FWD_INT5040
                                                                            WHERE HBL_NO = AX.HBL_NO )
                                                       UNION ALL
                                                      SELECT IFNULL(BX.STAT_CD, SUBSTR(AX.STATUS,2,2))   AS STATUS
                                                        FROM NFINF.TB_FWD_INT5940 AX
                                             LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG BX
                                                          ON AX.HBL_NO = BX.BL_NO
                                                       WHERE AX.HBL_NO = MAIN.BL_NO
                                                         AND BX.BL_ID = MAIN.BL_ID
                                                         AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                             FROM NFINF.TB_FWD_INT5940
                                                                            WHERE HBL_NO = AX.HBL_NO )) X1)
                                  END, 1, 100) IS NULL THEN 'N'
                      WHEN SUBSTR(CASE WHEN MAIN.BL_ID IS NULL THEN (SELECT MAX(X1.STATUS)
                                                                        FROM (
                                                                              SELECT STATUS
                                                                                FROM NFINF.TB_FWD_INT5040 AX
                                                                               WHERE AX.HBL_NO  = MAIN.BL_NO
                                                                                 AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                     FROM NFINF.TB_FWD_INT5040
                                                                                                    WHERE HBL_NO = AX.HBL_NO )
                                                                               UNION ALL
                                                                              SELECT SUBSTR(STATUS,2,2) AS STATUS
                                                                                FROM NFINF.TB_FWD_INT5940 AX
                                                                               WHERE AX.HBL_NO  = MAIN.BL_NO
                                                                                 AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                     FROM NFINF.TB_FWD_INT5940
                                                                                                    WHERE HBL_NO = AX.HBL_NO )) X1)
                                        ELSE (SELECT MAX(X1.STATUS)
                                                FROM (
                                                      SELECT IFNULL(BX.STAT_CD, AX.STATUS)   AS STATUS
                                                        FROM NFINF.TB_FWD_INT5040 AX
                                             LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG BX
                                                          ON AX.HBL_NO = BX.BL_NO
                                                       WHERE AX.HBL_NO = MAIN.BL_NO
                                                         AND BX.BL_ID = MAIN.BL_ID
                                                         AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                             FROM NFINF.TB_FWD_INT5040
                                                                            WHERE HBL_NO = AX.HBL_NO )
                                                       UNION ALL
                                                      SELECT IFNULL(BX.STAT_CD, SUBSTR(AX.STATUS,2,2))   AS STATUS
                                                        FROM NFINF.TB_FWD_INT5940 AX
                                             LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG BX
                                                          ON AX.HBL_NO = BX.BL_NO
                                                       WHERE AX.HBL_NO = MAIN.BL_NO
                                                         AND BX.BL_ID = MAIN.BL_ID
                                                         AND AX.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                             FROM NFINF.TB_FWD_INT5940
                                                                            WHERE HBL_NO = AX.HBL_NO )) X1)
                                  END, 1, 100) IN ('KY','DL','OK') THEN 'N'
                      ELSE 'Y' END) AS MFCS_ERR_YN
               ,SUBSTR(CASE WHEN MAIN.BL_ID IS NULL THEN (SELECT MAX(X1.STATUS)
                                                            FROM (
                                                                  SELECT (SELECT DTL_CD_NM
                                                                           FROM TB_COM_ETC_CD
                                                                          WHERE CLAS_CD = '0409'
                                                                            AND DTL_CD  = STATUS
                                                                            AND USE_YN ='Y') AS STATUS
                                                                    FROM NFINF.TB_FWD_INT5040 A
                                                                   WHERE A.HBL_NO = MAIN.BL_NO
                                                                     AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                        FROM NFINF.TB_FWD_INT5040
                                                                                       WHERE HBL_NO = A.HBL_NO )
                                                                   UNION ALL
                                                                  SELECT (SELECT DTL_CD_NM
                                                                           FROM TB_COM_ETC_CD
                                                                          WHERE CLAS_CD = '0409'
                                                                            AND DTL_CD  = STATUS
                                                                            AND USE_YN ='Y') AS STATUS
                                                                    FROM NFINF.TB_FWD_INT5940 A
                                                                   WHERE A.HBL_NO = MAIN.BL_NO
                                                                     AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                        FROM NFINF.TB_FWD_INT5940
                                                                                       WHERE HBL_NO = A.HBL_NO )) X1)
                            ELSE (SELECT MAX(X1.STATUS)
                                    FROM (
                                          SELECT IFNULL(B.STAT_CD, (SELECT DTL_CD_NM
                                                                      FROM TB_COM_ETC_CD
                                                                     WHERE CLAS_CD = '0409'
                                                                       AND DTL_CD  = STATUS
                                                                       AND USE_YN ='Y'))  AS STATUS
                                            FROM NFINF.TB_FWD_INT5040 A
                                 LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG B
                                              ON A.HBL_NO = B.BL_NO
                                           WHERE A.HBL_NO = MAIN.BL_NO
                                             AND B.BL_ID = MAIN.BL_ID
                                             AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                FROM NFINF.TB_FWD_INT5040
                                                               WHERE HBL_NO = A.HBL_NO )
                                           UNION ALL
                                          SELECT IFNULL(B.STAT_CD, (SELECT DTL_CD_NM
                                                                      FROM TB_COM_ETC_CD
                                                                     WHERE CLAS_CD = '0409'
                                                                       AND DTL_CD  = SUBSTR(STATUS,2,2)
                                                                       AND USE_YN ='Y'))  AS STATUS
                                            FROM NFINF.TB_FWD_INT5940 A
                                 LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG B
                                              ON A.HBL_NO = B.BL_NO
                                           WHERE A.HBL_NO = MAIN.BL_NO
                                             AND B.BL_ID = MAIN.BL_ID
                                             AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                FROM NFINF.TB_FWD_INT5940
                                                               WHERE HBL_NO = A.HBL_NO )) X1)
                       END, 1, 100) AS MFCS_STATUS
               ,SUBSTR(IFNULL(CASE WHEN MAIN.BL_ID IS NULL THEN ( SELECT MAX(X1.REMARK)
                                                                     FROM (
                                                                           SELECT REMARK
                                                                             FROM NFINF.TB_FWD_INT5040 A
                                                                            WHERE A.HBL_NO = MAIN.BL_NO
                                                                              AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                 FROM NFINF.TB_FWD_INT5040
                                                                                                WHERE HBL_NO = A.HBL_NO )
                                                                            UNION ALL
                                                                           SELECT REMARK
                                                                             FROM NFINF.TB_FWD_INT5940 A
                                                                            WHERE A.HBL_NO = MAIN.BL_NO
                                                                              AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                                                 FROM NFINF.TB_FWD_INT5940
                                                                                                WHERE HBL_NO = A.HBL_NO )) X1)
                                    ELSE (SELECT MAX(X1.REMARK)
                                            FROM (
                                                  SELECT IFNULL(B.AFT_MSG_CONT, A.REMARK) AS REMARK
                                                    FROM NFINF.TB_FWD_INT5040 A
                                         LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG B
                                                      ON A.HBL_NO = B.BL_NO
                                                   WHERE A.HBL_NO = MAIN.BL_NO
                                                     AND B.BL_ID  = MAIN.BL_ID
                                                     AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                        FROM NFINF.TB_FWD_INT5040
                                                                       WHERE HBL_NO = A.HBL_NO )
                                                   UNION ALL
                                                  SELECT IFNULL(B.AFT_MSG_CONT, A.REMARK) AS REMARK
                                                    FROM NFINF.TB_FWD_INT5940 A
                                         LEFT OUTER JOIN TB_FWD_MNFST_STAT_CHG B
                                                      ON A.HBL_NO = B.BL_NO
                                                   WHERE A.HBL_NO = MAIN.BL_NO
                                                     AND B.BL_ID = MAIN.BL_ID
                                                     AND A.RES_SEQ = (SELECT MAX(RES_SEQ)
                                                                        FROM NFINF.TB_FWD_INT5940
                                                                       WHERE HBL_NO = A.HBL_NO )) X1)
                              END, '미전송 또는 응답 미수신'), 1, 200) AS MFCS_ERROR
	           ,MAIN.AMS_FILE_NO
	           ,MAIN.BL_ID                  
	           ,MAIN.INTG_TASK_NO
	           ,MAIN.TASK_SPR_CD
	           ,(SELECT X1.DTL_CD_NM  
	               FROM TB_COM_ETC_CD  X1  
	              WHERE X1.CLAS_CD = '0031'  
	                AND X1.DTL_CD =  MAIN.TASK_SPR_CD 
	                AND X1.USE_YN ='Y') AS TASK_SPR_CD_NM
	           ,MAIN.UPDR_ID
	           ,MAIN.UPD_DT
	           ,'' AS STAT_CD
	           ,'' AS ID_TYPE
	           ,'' AS PREFIX
	           ,'' AS CLOSE_YN
	           ,'' AS CLOS_YN
	           ,MAIN.ARR_CLOS_AUTO_APLY_YN
	           ,MAIN.RPRS_ITEM_NM
	           ,MAIN.OFCR_EMPNO
	           ,(SELECT X1.ENG_EMP_NM 
	               FROM TB_COM_EMP X1 
	              WHERE X1.EMPNO = MAIN.OFCR_EMPNO) AS OFCR_EMPNM
	           ,(SELECT EMAIL_ADDR
	               FROM TB_COM_USER
	              WHERE USER_ID = MAIN.OFCR_EMPNO) AS OFCR_EMAIL
	           ,MAIN.ORG_OFCR_EMPNO
	           ,(SELECT X1.ENG_EMP_NM 
	               FROM TB_COM_EMP X1 
	              WHERE X1.EMPNO = MAIN.ORG_OFCR_EMPNO) AS ORG_OFCR_EMPNM
	           ,(SELECT EMAIL_ADDR
	               FROM TB_COM_USER
	              WHERE USER_ID = MAIN.ORG_OFCR_EMPNO) AS ORG_OFCR_EMAIL
	            ,MAIN.SALES_EMP_EMPNO
	           ,(SELECT X1.ENG_EMP_NM 
	               FROM TB_COM_EMP X1 
	              WHERE X1.EMPNO = MAIN.SALES_EMP_EMPNO) AS SALES_EMP_EMPNM
	           ,(SELECT X1.ENG_EMP_NM 
	               FROM TB_COM_EMP X1 
	              WHERE X1.EMPNO = MAIN.SALES_OFCR_EMPNO) AS SALES_OFCR_EMPNM
	           ,(CASE WHEN MAIN.BL_SWITCH_YN = 'Y' THEN (SELECT MBL_ID
	                                                       FROM TB_FWD_BL A
	                                                      WHERE DEL_YN  = 'N'
	                                                        AND IFNULL(A.BL_SWITCH_YN, 'N') = 'N'
	                                                        AND BL_ID = (SELECT ORIGN_BL_ID
	                                                                       FROM TB_FWD_BL
	                                                                      WHERE BL_ID = MAIN.BL_ID ))
	                  ELSE MAIN.MBL_ID END) AS MBL_ID
	           ,IFNULL(MAIN.BL_SWITCH_YN, 'N') AS BL_SWITCH_YN
	           ,IFNULL(MAIN.SWT_BL_YN, 'N') AS SWT_BL_YN
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '20'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE20
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '20'
	                AND T.CNTR_TYPE_CD = 'DR'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE20DR
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '20'
	                AND T.CNTR_TYPE_CD NOT IN ('DR')
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE20S
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '40'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE40
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '40'
	                AND T.CNTR_TYPE_CD = 'DR'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE40DR
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '45'
	                AND T.CNTR_TYPE_CD = 'DR'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE45DR
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO 
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '40'
	                AND T.CNTR_TYPE_CD = 'HC'
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE40HC
	           ,(SELECT COUNT(1)
	               FROM TB_FWD_BL_ITEM_MPNG X
	         INNER JOIN TB_SMT_INTG_ITEM    T
	                 ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N'
	                AND T.DEL_YN = 'N'
	                AND T.CNTR_YN = 'Y'
	                AND X.MPNG_KIND_CD = 'OMI'
	                AND T.CNTR_SIZE_CD = '40'
	                AND T.CNTR_TYPE_CD NOT IN ('DR', 'HC')
	                AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') AS CNTR_SIZE40S
	           ,(<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetMblTaskNo">
	                 <property name="blId" value="MAIN.BL_ID"></property>
	                 <property name="intgTaskNo" value="MAIN.INTG_TASK_NO"></property>
	             </include>) AS MBL_INTG_TASK_NO
	           ,MAIN.ORD_SPR_CD
               ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0514'
                           AND DTL_CD  = (<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetSwitchInfo">
                                            <property name="blId" value="MAIN.BL_ID"></property>
                                          </include>)
                           AND USE_YN ='Y') AS SWITCH_STATUS
	           ,(SELECT X.EXCT_BIZPTNR_CD
	               FROM TB_SMT_INTG_TASK_DEPT X
	              WHERE MAIN.EO_NO = X.EO_NO
	                AND MAIN.BL_ID = X.CST_BL_ID
	                AND X.DEL_YN = 'N'
	                AND X.TASK_SPR_CD = 'IMP') AS IMP_CORP_CD
	           ,MAIN.CORP_CD
	           ,MAIN.INCOT_CD
	           ,MAIN.ISSUED
	           ,(SELECT CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END
	               FROM TB_FWD_BL_ITEM_CHG X
	              WHERE X.BL_ID = MAIN.BL_ID
	                AND X.DEL_YN = 'N') AS IMP_MOD_YN
	           ,MAIN.SPLIT_BL_YN
	           ,(SELECT REPLACE(GROUP_CONCAT(X.EXP_LICE_NO, '' ORDER BY X.BL_ID, X.LICE_SEQ), ',', '/')
	               FROM TB_FWD_BL_EXP_LICE X
	              WHERE MAIN.BL_ID = X.BL_ID
	                AND X.DEL_YN = 'N') AS EL_NO
	           ,(SELECT (CASE WHEN ONBR_CLOS_YN = 'Y' THEN 'Y' ELSE (CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END ) END)
	               FROM TB_FWD_BL_PRT_APRV Y
	         INNER JOIN TB_FWD_BL_PRT_APRV_DTL Z
	                 ON Y.RQST_SEQ = Z.RQST_SEQ
	              WHERE Y.APRV_REQR_ID = #{userId}
	                AND Y.STEP_CD = '7777'
	                AND Z.BL_ID = MAIN.BL_ID ) AS BL_PRTN_APRV_YN
	           ,(SELECT CASE WHEN MAX(X.PRT_SPR_CD) = 'O' THEN 'OBL'
	                         WHEN MAX(X.PRT_SPR_CD) = 'S' THEN 'Surrender'
	                         WHEN MAX(X.PRT_SPR_CD) = 'W' THEN 'Seawaybill'
	                         WHEN MAX(X.PRT_SPR_CD) = 'C' THEN 'Check'
	                         WHEN MAX(X.PRT_SPR_CD) = 'D' THEN 'DRAFT'
	                         WHEN MAX(X.PRT_SPR_CD) = 'F' THEN 'FCR'
	                         ELSE 'N'
	                    END 
	               FROM TB_FWD_BL_PRT_OPTION X
	              WHERE X.BL_ID = MAIN.BL_ID                  
	                AND X.DEL_YN = 'N'
	                AND X.PRT_SEQ = (SELECT MAX(X1.PRT_SEQ)
	                                   FROM TB_FWD_BL_PRT_OPTION X1
	                                  WHERE X1.BL_ID = MAIN.BL_ID
	                                    AND X1.PRT_KIND_CD IN ('PRNT','EDMS')
	                                    AND X1.DOC_KIND_CD = 'HBL')) AS BL_PRT_TYPE
	           ,(SELECT CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END
	               FROM TB_SMT_ORD_CO_RELT X
	              WHERE X.DEL_YN = 'N'
	                AND X.SMT_NO = MAIN.SMT_NO) AS CO_BIND_YN
	           ,MAIN.RSLT_CORP_CD
	           ,'' AS PGM_ID
	           ,MAIN.NON_EXCT_BL_YN
	           ,MAIN.RSLT_DEPT_CD
	           ,(SELECT X1.ACCTG_DEPT_ENG_NM 
	               FROM TB_COM_ACCTG_DEPT  X1
	              WHERE X1.ACCTG_DEPT_CD = MAIN.RSLT_DEPT_CD ) AS RSLT_DEPT_NM
	           ,(SELECT CASE WHEN X1.ISF_SEND_YN = 'N' THEN 'ISF Not Send('||CAST(DD AS CHAR(2))||'days)' ELSE '' END
                   FROM (
                         SELECT IFNULL(C.ISF_SEND_YN,'N') AS ISF_SEND_YN
                               ,A.ONBR_YMD
                               ,C.ISF_SEND_DT
                               ,TRUNCATE(NOW(), 0) - (STR_TO_DATE(A.ONBR_YMD,'%Y-%m-%d') - 2) AS DD
                           FROM TB_FWD_BL A
                     INNER JOIN TB_SMT_INTG_TASK_DEPT B
                             ON A.BL_ID     = B.CST_BL_ID
                LEFT OUTER JOIN TB_FWD_ISF_HEADR C
                             ON A.BL_ID     = C.BL_ID
                     INNER JOIN TB_COM_LOC D
                             ON A.POD_CD      = D.LOC_CD
                          WHERE A.EO_NO       = B.EO_NO
                            AND A.DEL_YN      = 'N'
                            AND B.DEL_YN      = 'N'
                            AND C.DEL_YN      = 'N'
                            AND D.NATN_CD     = 'US'
                            AND B.TASK_SPR_CD = 'EXP'
                            AND A.BL_ID       = MAIN.BL_ID) X1 ) AS ISF_SEND_NM
	/*         ,FC_FW_GET_BL_STAT_TEXT('ISF_SEND', MAIN.BL_ID, MAIN.INTG_TASK_NO) AS ISF_SEND_NM*/
	           ,(SELECT X1.DTL_CD_NM  
	               FROM TB_COM_ETC_CD  X1  
	              WHERE X1.CLAS_CD = '1016'  
	                AND X1.DTL_CD = IFNULL(MAIN.BL_CRT_TYPE_CD, 'NOR') 
	                AND X1.USE_YN ='Y') AS BL_CRT_TYPE_NM
	           ,(SELECT Z.DEPT_CD
	               FROM TB_COM_EMP Z
	              WHERE Z.EMPNO = #{userId} ) AS USER_DEPT_CD
	           ,(SELECT Z.CORP_CD
	               FROM TB_COM_EMP Z
	              WHERE Z.EMPNO = #{userId} ) AS USER_CORP_CD
	           ,(SELECT B.MGR_EMPNO
	               FROM TB_COM_EMP A
	         INNER JOIN TB_COM_HR_DEPT B
	                 ON A.DEPT_CD = B.DEPT_CD
	                AND A.HR_COM_CD = B.HR_COM_CD
	              WHERE A.EMPNO = #{userId}  ) AS USER_MGR_EMPNO
	           ,(SELECT D.ENG_EMP_NM
	               FROM (SELECT B.MGR_EMPNO
	                       FROM TB_COM_EMP A
	                 INNER JOIN TB_COM_HR_DEPT B
	                         ON A.DEPT_CD = B.DEPT_CD
	                      WHERE A.HR_COM_CD = B.HR_COM_CD
	                        AND A.EMPNO = #{userId}) C
	         INNER JOIN TB_COM_EMP D
	                 ON C.MGR_EMPNO = D.EMPNO) AS USER_MGR_EMP_NM
	           ,MAIN.MBL_ROUT_SPR_CD
	           ,SUBSTR((SELECT X1.DTL_CD_NM  
	                      FROM TB_COM_ETC_CD  X1  
	                     WHERE X1.CLAS_CD = '0076'  
	                       AND X1.DTL_CD = MAIN.MBL_ROUT_SPR_CD 
	                       AND X1.USE_YN ='Y'), 1, 200) AS MBL_ROUT_SPR_NM
	           ,MAIN.MBL_PDEL_CD
	           ,MAIN.MBL_PDEL_NM
	           ,MAIN.DNGMATL_CD
	           ,SUBSTR((SELECT X1.DTL_CD_NM  
	                      FROM TB_COM_ETC_CD  X1  
	                     WHERE X1.CLAS_CD = '1251'  
	                       AND X1.DTL_CD = MAIN.DNGMATL_CLAS_CD 
	                       AND X1.USE_YN ='Y'), 1, 50) AS DNGMATL_CLAS_CD
	           ,MAIN.DNGMATL_UN_NO
	           ,MAIN.BILG_BIZPTNR_CD
	           ,SUBSTR(( SELECT X1.BIZPTNR_ENG_NM
	                       FROM TB_COM_BIZPTNR X1 
	                      WHERE X1.BIZPTNR_CD = MAIN.BILG_BIZPTNR_CD ),1, 50) AS BILG_BIZPTNR_NM
	           ,MAIN.LGC_SUR
	           ,(SELECT IP.BIZPTNR_OFCR_NM
	               FROM TB_FWD_INTG_PIC IP
	              WHERE IP.INTG_KEY_ID = MAIN.BL_ID
	                AND IP.DEL_YN      = 'N'
	              LIMIT 1) AS BIZPTNR_OFCR_NM
	           ,MAIN.M_TERM
	           ,(SELECT BP.BIZMAN_REG_NO
	               FROM TB_COM_BIZPTNR BP
	              WHERE BP.BIZPTNR_CD = MAIN.SHPP_CD
	                AND BP.USE_YN     = 'Y' ) AS SHPP_REG_NO
	           ,(SELECT BP.BIZMAN_REG_NO
	               FROM TB_COM_BIZPTNR BP
	              WHERE BP.BIZPTNR_CD = MAIN.CNEE_CD
	                AND BP.USE_YN     = 'Y' ) AS CNEE_REG_NO
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	               FROM VW_ED_STATUS_01 X
	              WHERE X.SO_NO = MAIN.SO_NO
	                AND X.DOC_TYPE = '08'
	                AND X.REG_DT = (SELECT MAX(REG_DT)
	                                  FROM VW_ED_STATUS_01 
	                                 WHERE SO_NO = MAIN.SO_NO
	                                   AND DOC_TYPE = '08')
	              LIMIT 1) AS EDMS_CI
	           */
	           ,'' AS EDMS_CI
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	               FROM VW_ED_STATUS_01 X
	              WHERE X.SO_NO = MAIN.SO_NO
	                AND X.DOC_TYPE = '09'
	                AND X.REG_DT = (SELECT MAX(REG_DT)
	                                  FROM VW_ED_STATUS_01 
	                                 WHERE SO_NO = MAIN.SO_NO
	                                   AND DOC_TYPE = '09')
	              LIMIT 1) AS EDMS_PL
	           */
	           ,'' AS EDMS_PL
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	               FROM VW_ED_STATUS_01 X
	              WHERE X.SO_NO = MAIN.SO_NO
	                AND X.DOC_TYPE = '31'
	                AND X.REG_DT = (SELECT MAX(REG_DT)
	                                  FROM VW_ED_STATUS_01 
	                                 WHERE SO_NO = MAIN.SO_NO
	                                   AND DOC_TYPE = '31')
	              LIMIT 1) AS EDMS_CIPL
	           */
	           ,'' AS EDMS_CIPL
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	                 FROM   VW_ED_STATUS_01 X
	                 WHERE  X.BL_ID = MAIN.MBL_BL_ID
	                 AND    X.BL_NO = MAIN.MBL_BL_NO
	                 AND    X.SO_NO = MAIN.MBL_SO_NO
	                 AND    X.EO_NO = MAIN.MBL_EO_NO
	                 AND    X.DOC_TYPE = '01'
	                 AND    X.REG_DT = (SELECT MAX(REG_DT)
	                                    FROM   VW_ED_STATUS_01 
	                                    WHERE  BL_ID = MAIN.MBL_BL_ID
	                                    AND    BL_NO = MAIN.MBL_BL_NO
	                                    AND    SO_NO = MAIN.MBL_SO_NO
	                                    AND    EO_NO = MAIN.MBL_EO_NO
	                                    AND    DOC_TYPE = '01')
	                 AND    ROWNUM = 1)) AS EDMS_MBL
	           */
	           ,'' AS EDMS_MBL
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	                 FROM   VW_ED_STATUS_01 X
	                 WHERE  X.BL_ID = MAIN.BL_ID
	                 AND    X.BL_NO = MAIN.BL_NO
	                 AND    X.SO_NO = MAIN.SO_NO
	                 AND    X.EO_NO = MAIN.EO_NO
	                 AND    X.DOC_TYPE IN DECODE( MAIN.BL_SPR_CD , 'H' , '04' ,'01' )
	                 AND    X.REG_DT = (SELECT MAX(REG_DT)
	                                    FROM   VW_ED_STATUS_01 
	                                    WHERE  BL_ID = MAIN.BL_ID
	                          AND    BL_NO = MAIN.BL_NO
	                          AND    SO_NO = MAIN.SO_NO
	                          AND    EO_NO = MAIN.EO_NO
	                          AND    DOC_TYPE IN DECODE( MAIN.BL_SPR_CD , 'H' , '04' ,'01' ))
	                 AND    ROWNUM = 1) AS EDMS_HBL
	           */
	           ,'' AS EDMS_HBL
	           /*
	           ,(SELECT DECODE(X.IMG_STATUS, 'C', '√', 'U', '△', '')
	                 FROM   VW_ED_STATUS_01 X
	                 WHERE  X.SO_NO = MAIN.SO_NO
	                 AND    X.DOC_TYPE = '112'
	                 AND    X.REG_DT = (SELECT MAX(REG_DT)
	                                    FROM   VW_ED_STATUS_01 
	                                    WHERE  SO_NO = MAIN.SO_NO
	                                    AND    DOC_TYPE = '112')
	                 AND    ROWNUM = 1) AS EDMS_DPL
	           */
	           ,'' AS EDMS_DPL
	           ,MAIN.ASGN_TYPE_CD
	           ,SUBSTR((SELECT X1.DTL_CD_NM  
	                      FROM TB_COM_ETC_CD  X1  
	                     WHERE X1.CLAS_CD = '0266'  
	                       AND X1.DTL_CD = MAIN.ASGN_TYPE_CD 
	                       AND X1.USE_YN ='Y'), 1, 50) AS ASGN_TYPE_NM
	           ,MAIN.EMPTY_CNTR_RTN_CY_CD
	           ,MAIN.EMPTY_CNTR_CY_NM
	           ,SHIPLN_BKNG_NO
               ,MAIN.ETD_YMD
               ,MAIN.ETA_YMD
               ,CONCAT((SELECT A.DTL_CD_NM
                          FROM (
                                SELECT GROUP_CONCAT(CONCAT(IFNULL(X.CNTR_NO,''),  "/", IFNULL(X.SEAL1,''), CHAR(13), "(", IFNULL(FORMAT(X.WGT,3),0), "KG/", IFNULL(FORMAT(X.VOL,3),0), "M3/", IFNULL(X.QTY,0), IFNULL(X.QTY_UNIT_CD,''), ")", IFNULL(X.SEAL2, IFNULL(X.SEAL3, '')), '/', CHAR(10)) ORDER BY X.INTG_ITEM_NO SEPARATOR '') AS DTL_CD_NM
                                  FROM TB_SMT_INTG_ITEM X
                            INNER JOIN TB_FWD_BL_ITEM_MPNG XX
                                    ON X.INTG_ITEM_NO = XX.INTG_ITEM_NO                                      
                                 WHERE XX.MPNG_KIND_CD = 'OMI'
                                   AND XX.BL_ID = MAIN.BL_ID
                                   AND X.CNTR_YN = 'Y'
                                   AND X.DEL_YN = 'N'
                                   AND XX.DEL_YN = 'N'
                                 LIMIT 30) A), CHAR(13),
                               (SELECT IFNULL(S.FRM_CONT, '')  AS FRM_CONT
                                  FROM TB_FWD_INTG_RMK      S         /* 통합비고 */
                                 WHERE S.DEL_YN = 'N'                /* 삭제여부 */
                                   AND S.INTG_KEY_ID = MAIN.BL_ID
                                   AND S.RMK_SPR_CD = 'MARK')) AS CNTR_LIST
               ,MAIN.FRGTTERM_CD
              ,(SELECT CONCAT(B.DTL_CD_NM, CONCAT(FORMAT(MAIN.PKG_QTY, 0) , ' ' , TRIM(MAIN.PKG_NM)))
                 FROM (
                       SELECT GROUP_CONCAT(A.DTL_CD_NM ORDER BY A.CNTR_SIZE_CD SEPARATOR ',') AS DTL_CD_NM
                         FROM (
                               SELECT CONCAT(COUNT(1), 'X', IFNULL(X.CNTR_SIZE_CD,''), ' ', IFNULL(X.CNTR_TYPE_CD,''), '\n') AS DTL_CD_NM, X.CNTR_SIZE_CD
                                 FROM TB_SMT_INTG_ITEM X
                           INNER JOIN TB_FWD_BL_ITEM_MPNG XX
                                   ON X.INTG_ITEM_NO = XX.INTG_ITEM_NO
                                WHERE XX.BL_ID = MAIN.BL_ID
                                  AND XX.MPNG_KIND_CD = 'OMI'
                                  AND X.CNTR_YN = 'Y'
                                  AND X.DEL_YN = 'N'
                                  AND XX.DEL_YN = 'N'
                             GROUP BY X.CNTR_SIZE_CD
                                     ,X.CNTR_TYPE_CD) A) B) AS NO_OF_CNTR
              ,CONCAT((SELECT A.DTL_CD_NM
                         FROM (
                               SELECT GROUP_CONCAT(CONCAT(IFNULL(X.CNTR_NO,''),  "/", IFNULL(X.SEAL1,''), IFNULL(X.SEAL2, IFNULL(X.SEAL3, '')), '/', '\n') ORDER BY X.INTG_ITEM_NO SEPARATOR '') AS DTL_CD_NM
                                 FROM TB_SMT_INTG_ITEM X
                           INNER JOIN TB_FWD_BL_ITEM_MPNG XX
                                   ON X.INTG_ITEM_NO = XX.INTG_ITEM_NO                                      
                                WHERE XX.MPNG_KIND_CD = 'OMI'
                                  AND XX.BL_ID = MAIN.BL_ID
                                  AND X.CNTR_YN = 'Y'
                                  AND X.DEL_YN = 'N'
                                  AND XX.DEL_YN = 'N'
                                LIMIT 30) A),
                              (SELECT IFNULL(S.FRM_CONT, '')  AS FRM_CONT
                                 FROM TB_FWD_INTG_RMK      S         /* 통합비고 */
                                WHERE S.DEL_YN = 'N'                /* 삭제여부 */
                                  AND S.INTG_KEY_ID = MAIN.BL_ID
                                  AND S.RMK_SPR_CD = 'MARK')) AS CNTR_DESC
              ,TRIM(CONCAT(FORMAT(MAIN.PKG_QTY, 0), ' ', MAIN.PKG_NM)) AS PKGS
              ,(SELECT S.FRM_CONT
                  FROM TB_FWD_INTG_RMK      S
                 WHERE S.DEL_YN = 'N'
                   AND S.INTG_KEY_ID = MAIN.BL_ID
                   AND S.RMK_SPR_CD = 'DESC') GOODS_DESC
               ,MAIN.SELL_CFT
               ,'CFT' AS CFT_NM
               ,'CBM(M3)' AS CBM_NM
               ,'Net Weight' AS NET_WEIGHT_NM
               ,MAIN.SELL_NWT
               ,MAIN.SELL_LB_GWT
               ,MAIN.US_ONBR_YMD
               ,MAIN.US_FLT_VSL_NM
               ,MAIN.US_POL_NM
               ,MAIN.FRT_TERM
               ,MAIN.PREPAID_YN
               ,MAIN.COLLECT_YN
               ,MAIN.ARRN_CONT
               ,(CASE WHEN #{bizptnrCd} = 'H100' AND MAIN.FRGTTERM_CD = 'PP' THEN SUBSTR('', 0, 200) ELSE MAIN.FRT_PAYBLE_AT END) AS FRT_PAYBLE_AT
               ,MAIN.NO_OF_ORG_BL
               ,MAIN.BL_PRT_PLACE
               ,MAIN.BL_PRT_YMD
               ,MAIN.USER_TXT_NM
	       FROM (
	              SELECT C.ORD_TYPE_CD
	                    ,B.SMT_NO                          /* so번호 */
	                    ,B.EO_NO                          /* eo번호 */
	                    ,A.BL_NO                          /* hbl번호 */
	                    ,A.SR_NO
	                    ,A.MBL_NO
	                    ,A.BL_ID                          /* BLID */
	                    ,A.MBL_ID
	                    ,D.INTG_TASK_NO                   /* 통합역할번호 */
	                    ,D.TASK_SPR_CD                    /* 역할구분코드 :0031 */              
	                    ,IFNULL(A.IMP_BL_SPLIT_ADJ_YN, 'N') AS IMP_BL_SPLIT_ADJ_YN
	                    ,A.WGT_CLOS_YN /* hbl close yn*/
	                    ,A.ONBR_CLOS_YN                   /* 출항마감여부 */
	                    ,A.ARR_CLOS_YN
	                    ,A.EXP_CC_RQST_YN                 /* 수출통관요청여부 */
	                    ,A.IMP_CC_RQST_YN                 /* 수입통관요청여부 */
	                    ,A.BL_SPR_CD                      /* bl type, bl구분코드(BL구분(M : MBL, H:HBL, D:DBL, C:코로드BL)) */              
	                    ,A.EXCT_SPR_CD
	                    ,A.LADG_TYPE_CD                   /* 적재유형코드, load type */              
	                    ,A.ONBR_YMD                       /* 출항일자 */
	                    ,A.ARR_YMD                        /* 입항일자 */          
	                    ,A.CARR_GRP_CD                    /* 운송사그룹코드 */
	                    ,A.CARR_NM                        /* 운송사명 */
	                    ,D.CARR_CD              
	                    ,D.AGNT_CD
	                    ,A.FLT_VSL_NM                     /* 편기선명 */
	                    ,A.VOYAGE                         /* 항차 */
	                    ,A.POR_CD
	                    ,A.POR_NM                         /* por명 */
	                    ,A.POL_CD
	                    ,A.POL_NM                         /* pol명 */
	                    ,A.POD_CD
	                    ,A.POD_NM                         /* pod명 */
	                    ,A.PDEL_CD
	                    ,A.PDEL_NM                        /* pdel명 */
	                    ,A.FDEST_CD
	                    ,A.FDEST_NM                       /* fdest명 */
	                    ,A.SHPP_CD                        /* 송화주코드 */
	                    ,A.CNEE_CD                        /* 수화주코드 */
	                    ,A.NTPR_CD                        /* 통지처코드 */
	                    ,A.SHPP_NM                        /* 송화주명 */              
	                    ,A.CNEE_NM                        /* 수화주명 */
	                    ,A.NTPR_NM                        /* 통지처명 */
	                    ,IFNULL(A.SELL_GWT,0) AS SELL_GWT /* G/wt(매출총중량) */
	                    ,IFNULL(A.SELL_CBM,0) AS SELL_CBM /* 매출cbm */
	                    ,IFNULL(A.PKG_QTY,0)  AS PKG_QTY  /* 패키지수량 */
	                    ,A.PKG_UNIT_CD                    /* 패키지단위코드 */              
	                    ,A.CARGO_TYPE_CD                  /* 화물유형코드   */              
	                    ,A.RPRS_REF_NO                    /* 대표참조번호   */
	                    ,D.CONF_REQD_YN
	                    ,D.CONF_YN              
	                    ,F.AMS_FILE_NO              
	                    ,A.UPDR_ID                        /* 수정자id       */
	                    ,A.UPD_DT                         /* 수정일시       */
	                    ,H.PKG_NM
	                    ,'' AS STAT_CD
	                    ,'' AS ID_TYPE
	                    ,'' AS PREFIX
	                    ,'' AS CLOSE_YN
	                    ,'' AS CLOS_YN
	                    ,IFNULL(F.ARR_CLOS_AUTO_APLY_YN, 'N') AS ARR_CLOS_AUTO_APLY_YN
	                    ,A.RPRS_ITEM_NM
	                    ,D.OFCR_EMPNO
	                    ,(SELECT OFCR_EMPNO AS ORG_OFCR_EMPNO
	                        FROM TB_SMT_INTG_TASK_DEPT
	                       WHERE EO_NO = A.EO_NO                  
	                         AND TASK_SPR_CD = 'EXP'
	                         AND DEL_YN = 'N'
	                       LIMIT 1) AS ORG_OFCR_EMPNO              
	                    ,E.SALES_EMP_EMPNO   
	                    ,C.SALES_OFCR_EMPNO
	                    ,IFNULL(A.BL_SWITCH_YN, 'N') AS BL_SWITCH_YN
	                    ,IFNULL(C.SWT_BL_YN, 'N') AS SWT_BL_YN              
	                    ,C.ORD_SPR_CD              
	                    ,#{bizptnrCd} AS CORP_CD
	                    ,A.INCOT_CD
	                    ,(CASE WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'N' THEN 'PROCESSING' WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'Y' THEN 'ISSUED' END) AS ISSUED               
	                    ,IFNULL(A.SPLIT_BL_YN, 'N') AS SPLIT_BL_YN 
	                    ,D.EXCT_BIZPTNR_CD AS RSLT_CORP_CD
	                    ,'' AS PGM_ID
	                    ,A.NON_EXCT_BL_YN
	                    ,D.RSLT_DEPT_CD              
	                    ,A.BL_CRT_TYPE_CD  
	                    ,G.ROUT_SPR_CD AS MBL_ROUT_SPR_CD              
	                    ,G.PDEL_CD AS MBL_PDEL_CD
	                    ,G.PDEL_NM AS MBL_PDEL_NM
	                    ,F.DNGMATL_CD              
	                    ,H.DNGMATL_CLAS_CD
	                    ,H.DNGMATL_UN_NO
	                    ,E.BILG_BIZPTNR_CD              
	                    ,CASE WHEN A.RMK LIKE '%SURRENDER%' THEN 'Y' ELSE 'N' END AS LGC_SUR              
	                    ,G.FRGTTERM_CD AS M_TERM   /* [CSR ID:3826547] HBL List(FW00000004) - CC/PP 정산TERM 열추가 요청 */
	                    ,F.ASGN_TYPE_CD  
	                    ,G.BL_ID AS MBL_BL_ID
	                    ,G.BL_NO AS MBL_BL_NO
	                    ,G.SMT_NO AS MBL_SMT_NO
	                    ,G.EO_NO AS MBL_EO_NO
	                    ,F.EMPTY_CNTR_RTN_CY_CD
	                    ,(SELECT X.ENG_LOC_NM 
	                        FROM TB_COM_LOC X
	                       WHERE X.LOC_CD = TRIM(F.EMPTY_CNTR_RTN_CY_CD)) AS EMPTY_CNTR_CY_NM
	                    ,A.SHIPLN_BKNG_NO
                        ,A.ETD_YMD
                        ,A.ETA_YMD
                        ,A.FRGTTERM_CD
                        ,A.SELL_CFT
                        ,A.SELL_NWT
                        ,A.SELL_LB_GWT
                        ,UPPER(DATE_FORMAT(STR_TO_DATE(IFNULL(A.NEGO_ONBR_YMD, A.ONBR_YMD), '%Y%m%d'), '%b %d,%Y')) AS US_ONBR_YMD
                        ,CONCAT(A.FLT_VSL_NM, ' ', A.VOYAGE) AS US_FLT_VSL_NM
                        ,A.POL_NM AS US_POL_NM
                        ,CASE WHEN A.FRGTTERM_CD = 'PP' THEN 'FREIGHT PREPAID'
                              WHEN A.FRGTTERM_CD = 'CC' THEN 'FREIGHT COLLECT' END AS FRT_TERM
                        ,(CASE WHEN A.FRGTTERM_CD = 'PP' THEN 'PREPAID' ELSE '' END) AS PREPAID_YN
                        ,(CASE WHEN A.FRGTTERM_CD = 'CC' THEN 'COLLECT' ELSE '' END) AS COLLECT_YN
                        ,(SELECT ARRN_CONT
                            FROM TB_FWD_BL_PRT_EXPND T
                           WHERE T.BL_ID = A.BL_ID) AS ARRN_CONT /* TOTAL_CHARGES etc2 */                        
                        ,(CASE WHEN A.FRGTTERM_CD = 'PP' THEN (CASE WHEN (SELECT X.EXCT_BIZPTNR_CD
                                                                            FROM TB_SMT_INTG_TASK_DEPT X
                                                                           WHERE A.EO_NO = X.EO_NO
                                                                             AND A.BL_ID = X.CST_BL_ID
                                                                             AND X.DEL_YN = 'N'
                                                                             AND X.TASK_SPR_CD = 'EXP'
                                                                           LIMIT 1) = 'A100'
                                                                             AND A.SHPP_CD IN (SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.BIZPTNR_CD = '2000210'
                                                                                                UNION ALL
                                                                                               SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.MBIZPTNR_CD = '2000210'
                                                                                                UNION ALL
                                                                                               SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.UPPR_BIZPTNR_CD = '2000210'
                                                                                                UNION ALL
                                                                                               SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.BIZPTNR_CD = '2240609'
                                                                                                UNION ALL
                                                                                               SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.MBIZPTNR_CD = '2240609'
                                                                                                UNION ALL
                                                                                               SELECT X.BIZPTNR_CD
                                                                                                 FROM TB_COM_BIZPTNR X
                                                                                                WHERE X.USE_YN     = 'Y'
                                                                                                  AND X.UPPR_BIZPTNR_CD = '2240609') THEN ''
                                                                  WHEN #{bizptnrCd} = 'A100' THEN 'SEOUL, KOREA'
                                                                  ELSE CONCAT((SELECT ( SELECT ENG_LOC_NM
                                                                                          FROM TB_COM_LOC
                                                                                         WHERE LOC_CD = TRIM(X.CTY_CD))
                                                                                 FROM TB_COM_USER X
                                                                                WHERE X.USER_ID = #{session.userId}
                                                                                LIMIT 1) , ',' ,
                                                                              (SELECT (SELECT ENG_LOC_NM
                                                                                         FROM TB_COM_LOC
                                                                                        WHERE LOC_CD = TRIM(X.NATN_CD))
                                                                                 FROM TB_COM_USER X
                                                                                WHERE X.USER_ID = #{session.userId}
                                                                                LIMIT 1))
                                                             END)
                               WHEN A.FRGTTERM_CD = 'CC' THEN 'DESTINATION'
                         END) AS FRT_PAYBLE_AT
                        ,'' AS NO_OF_ORG_BL
                        ,'SEOUL, KOREA' AS BL_PRT_PLACE
                        ,A.BL_PRT_YMD
                        ,SUBSTR((CASE WHEN #{userTxtNm} IS NOT NULL THEN #{userTxtNm}
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'A' THEN 'AS A CARRIER'
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'B' THEN 'AS A CARRIER'
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'C' THEN ''
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'D' THEN ''
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'E' THEN ''
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'F' THEN ''
                                      WHEN SUBSTR(#{bizptnrCd}, 1, 1) = 'G' THEN ''
                                      ELSE ''
                                 END), 0, 200) AS USER_TXT_NM
                        ,'' AS LBS_NM
	                FROM TB_FWD_BL             A
	          INNER JOIN TB_SMT_EO             B
	                  ON A.EO_NO = B.EO_NO
	          INNER JOIN TB_SMT_ORD             C
	                  ON A.SMT_NO = C.SMT_NO
	          INNER JOIN TB_SMT_INTG_TASK_DEPT D
	                  ON A.BL_ID = D.CST_BL_ID
	                 AND B.EO_NO = D.EO_NO
	     LEFT OUTER JOIN TB_SMT_ORD_SELL_BILG   E
	                  ON A.SMT_NO = E.SMT_NO
	                 AND E.SELL_BIZPTNR_CD = #{bizptnrCd}
	          INNER JOIN TB_FWD_BL_EXPND       F
	                  ON A.BL_ID = F.BL_ID
	     LEFT OUTER JOIN TB_FWD_BL             G
	                  ON A.MBL_ID = G.BL_ID
	          INNER JOIN TB_FWD_BL_PRT_EXPND   H
	                  ON A.BL_ID = H.BL_ID
         LEFT OUTER JOIN TB_SMT_INTG_TASK_DEPT I
                      ON I.EO_NO = A.EO_NO
                     AND I.DEL_YN = 'N'
                     AND I.TASK_SPR_CD = 'IMP'
        <choose>
            <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "CNTR"'>
              INNER JOIN (SELECT DISTINCT T.SMT_NO
                            FROM TB_SMT_INTG_ITEM T 
                           WHERE T.CNTR_NO IN <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                       #{blno}
                                              </foreach>
                             AND T.DEL_YN = 'N') I
                      ON A.SMT_NO = I.SMT_NO
            </when>
            <otherwise>
                 <if test="blno != null and blno != '' and noType == 'CNTR'">
              INNER JOIN (SELECT DISTINCT T.SMT_NO
                            FROM TB_SMT_INTG_ITEM T 
                           WHERE T.CNTR_NO IN <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                       #{blno}
                                              </foreach>
                             AND T.DEL_YN = 'N') I
                      ON A.SMT_NO = I.SMT_NO
                 </if>                    
            </otherwise>
        </choose>
	               WHERE A.EXCT_SPR_CD = 'OC'
	                 AND A.BL_SPR_CD IN ('H', 'D')
	                 AND A.DEL_YN          = 'N'
	                 AND B.DEL_YN          = 'N'
	                 AND C.DEL_YN          = 'N'
	                 AND D.EXCT_BIZPTNR_CD = #{bizptnrCd}
	                 AND D.DEL_YN          = 'N'
        <choose>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "BL"'>
                        AND A.BL_NO IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "EO"'>
                        AND A.EO_NO IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "SMT"'>
                        AND A.SMT_NO IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "SR"'>
                        AND A.SR_NO IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "MBL"'>
                        AND A.MBL_NO
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>                        
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "VSL"'>
                        AND A.FLT_VSL_NM IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "LNBKNG"'>
                        AND A.SHIPLN_BKNG_NO IN
                                        <foreach collection="directSearchNoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </when>
                    <otherwise>
                    <if test="blno != null and blno != '' and noType =='BL'">
                        AND A.BL_NO IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="blno != null and blno != '' and noType =='SMT'">
                        AND A.SMT_NO IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="blno != null and blno != '' and noType =='SR'">
                        AND A.SR_NO IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="blno != null and blno != '' and noType =='MBL'">
                        AND A.MBL_NO IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="blno != null and blno != '' and noType =='VSL'">
                        AND A.FLT_VSL_NM IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="blno != null and blno != '' and noType =='LNBKNG'">
                        AND A.SHIPLN_BKNG_NO IN
                                        <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                                 #{blno}
                                        </foreach>
                    </if>
                    <if test="dateType != null and dateType != '' and dateType =='OB'">
                        AND A.ONBR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                    </if>
                    <if test="dateType != null and dateType != '' and dateType =='AR'">
                        AND A.ARR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                    </if>
                    <if test="dateType != null and dateType != '' and dateType =='EO'">
                        AND B.REG_DT BETWEEN DATE_FORMAT(#{udc_fromToCal_from}, '%Y/%m/%d') AND DATE_FORMAT(DATEADD(DAY, 1, #{udc_fromToCal_to}), '%Y/%m/%d')
                    </if>
                    <if test="closeType != null and closeType != '' and closeType =='OC'">
                        AND A.ONBR_CLOS_YN LIKE IFNULL(#{closeYn}, '%')
                    </if>
                    <if test="closeType != null and closeType != '' and closeType =='AC'">
                        AND A.ARR_CLOS_YN LIKE IFNULL(#{closeYn}, '%')
                    </if>
                    <if test='closeType != null and closeType != "" and closeType =="HB" and closeYn =="Y"'>
                        AND (A.BL_NO IS NULL OR A.BL_NO = '')
                    </if>
                    <if test='closeType != null and closeType != "" and closeType =="HB" and closeYn =="N"'>
                        AND A.BL_NO IS NOT NULL
                    </if>
                    <if test="blSprCd != null and blSprCd != ''">
                        AND A.BL_SPR_CD = #{blSprCd}
                    </if>
                    <if test="nonExctBlYn != null and nonExctBlYn != ''">
                        AND A.NON_EXCT_BL_YN = #{nonExctBlYn}
                    </if>
                    <if test="exctSprCd != null and exctSprCd != ''">
                        AND A.EXCT_SPR_CD = #{exctSprCd}
                    </if>
                    <if test="incotCd != null and incotCd != ''">
                        AND A.INCOT_CD = #{incotCd}
                    </if>
                    <if test="blCrtType != null and blCrtType != ''">
                        AND IFNULL(A.BL_CRT_TYPE_CD, 'NOR') = #{blCrtType}
                    </if>
                    <if test="asgnTypeCd != null and asgnTypeCd != ''">
                        AND F.ASGN_TYPE_CD = #{asgnTypeCd}
                    </if>
                    <if test='porCd != null and porCd != "" and porType == "P"'>
                        AND A.POR_CD = #{porCd}
                    </if>
                    <if test='porCd != null and porCd != "" and porType == "NA"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = A.POR_CD
                                       AND X.NATN_CD = #{porCd})
                    </if>
                    <if test='porCd != null and porCd != "" and porType == "RG"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = SUBSTR(A.POR_CD, 1, 2)
                                       AND X.NATN_CD = #{porCd})
                    </if>
                    <if test='polCd != null and polCd != "" and polType == "P"'>
                        AND A.POL_CD = #{polCd}
                    </if>
                    <if test='polCd != null and polCd != "" and polType == "NA"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = A.POL_CD
                                       AND X.NATN_CD = #{polCd})
                    </if>
                    <if test='polCd != null and polCd != "" and polType == "RG"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = SUBSTR(A.POL_CD, 1, 2)
                                       AND X.NATN_CD = #{polCd})
                    </if>
                    <if test='podCd != null and podCd != "" and podType == "P"'>
                        AND A.POD_CD = #{podCd}
                    </if>
                    <if test='podCd != null and podCd != "" and podType == "NA"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = A.POD_CD
                                       AND X.NATN_CD = #{podCd})
                    </if>
                    <if test='podCd != null and podCd != "" and podType == "RG"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = SUBSTR(A.POD_CD, 1, 2)
                                       AND X.NATN_CD = #{podCd})
                    </if>
                    <if test='pdelCd != null and pdelCd != "" and pdelType == "PD"'>
                        AND A.PDEL_CD = #{pdelCd}
                    </if>
                    <if test='pdelCd != null and pdelCd != "" and pdelType == "NA"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = A.PDEL_CD
                                       AND X.NATN_CD = #{pdelCd})
                    </if>
                    <if test='pdelCd != null and pdelCd != "" and pdelType == "RG"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = SUBSTR(A.PDEL_CD, 1, 2)
                                       AND X.NATN_CD = #{pdelCd})
                    </if>
                    <if test='fdestCd != null and fdestCd != "" and fdestType == "P"'>
                        AND A.FDEST_CD = #{fdestCd}
                    </if>
                    <if test='fdestCd != null and fdestCd != "" and fdestType == "NA"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = A.FDEST_CD
                                       AND X.NATN_CD = #{fdestCd})
                    </if>
                    <if test='fdestCd != null and fdestCd != "" and fdestType == "RG"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_COM_LOC X
                                     WHERE X.USE_YN = 'Y'
                                       AND X.LOC_CD = SUBSTR(A.FDEST_CD, 1, 2)
                                       AND X.NATN_CD = #{fdestCd})
                    </if>
                    <if test="lnCd != null and lnCd != ''">
                        AND D.CARR_CD = #{lnCd}
                    </if>
                    <if test='shprCd != null and shprCd != ""'>
                        AND A.SHPP_CD = #{shprCd}
                    </if>
                    <if test="cneeCd != null and cneeCd != ''">
                        AND A.CNEE_CD = #{cneeCd}
                    </if>
                    <if test="ntfyCd != null and ntfyCd != ''">
                        AND A.NTPR_CD = #{ntfyCd}
                    </if>
                    <if test="refno != null and refno != ''">
                        AND EXISTS (SELECT 1
                                      FROM TB_FWD_INTG_REF_NO   X
                                     WHERE X.DEL_YN = 'N'
                                       AND X.INTG_KEY_ID = A.BL_ID
                                       AND X.REF_NO_SPR_CD = IFNULL(#{refnoType}, X.REF_NO_SPR_CD)
                                       AND X.REF_NO IN  <foreach collection="refnoList" item="refno" index="index" separator="," open="(" close=")">
                                                                 #{refno}
                                                        </foreach>)
                    </if>
                    <if test="impModYn != null and impModYn != ''">
                        AND (CASE WHEN (SELECT COUNT(1)
                                          FROM TB_FWD_BL_ITEM_CHG X
                                         WHERE X.BL_ID = A.BL_ID
                                           AND X.DEL_YN = 'N') = 0 THEN 'N' ELSE 'Y' END) = #{impModYn}
                    </if>
                    <if test='prtlYn != null and prtlYn != "" and prtlYn == "Y"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_FWD_BL_ITEM_MPNG X
                                INNER JOIN TB_SMT_INTG_ITEM    T
                                        ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                                     WHERE X.BL_ID = A.BL_ID
                                       AND X.DEL_YN = 'N'
                                       AND T.DEL_YN = 'N'
                                       AND T.CNTR_YN = 'Y'
                                       AND X.MPNG_KIND_CD = 'OMI'
                                       AND T.FULL_PRTL_SPR_CD = 'P')
                    </if>
                    <if test='prtlYn != null and prtlYn != "" and prtlYn == "N"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_FWD_BL_ITEM_MPNG X
                                INNER JOIN TB_SMT_INTG_ITEM    T
                                        ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                                     WHERE X.BL_ID = A.BL_ID
                                       AND X.DEL_YN = 'N'
                                       AND T.DEL_YN = 'N'
                                       AND T.CNTR_YN = 'Y'
                                       AND X.MPNG_KIND_CD = 'OMI'
                                       AND T.FULL_PRTL_SPR_CD = 'F')
                    </if>
                    <if test='coBindYn != null and coBindYn != "" and coBindYn == "Y"'>
                        AND EXISTS (SELECT 1
                                      FROM TB_SMT_ORD_CO_RELT X
                                     WHERE X.DEL_YN = 'N'
                                       AND X.SMT_NO = C.SMT_NO)
                    </if>
                    <if test='coBindYn != null and coBindYn != "" and coBindYn == "N"'>
                        AND NOT EXISTS (SELECT 1
                                          FROM TB_SMT_ORD_CO_RELT X
                                         WHERE X.DEL_YN = 'N'
                                           AND X.SMT_NO = C.SMT_NO)
                    </if>
                    <if test="blSwitchYn != null and blSwitchYn != ''">
                        AND A.BL_SWITCH_YN = #{blSwitchYn}
                    </if>
                    <if test="oblYn != null and oblYn != ''">
                        AND IFNULL(A.ORIGN_PRNT_YN, 'N') = #{oblYn}
                    </if>
                    <if test="trnTypeCd != null and trnTypeCd != ''">
                        AND A.TRN_TYPE_CD = #{trnTypeCd}
                    </if>
                    <if test="cargoTypeCd != null and cargoTypeCd != ''">
                        AND A.CARGO_TYPE_CD = #{cargoTypeCd}
                    </if>
                    <if test="loadType != null and loadType != ''">
                        AND A.LADG_TYPE_CD = #{loadType}
                    </if>
                    <if test='operation != null and operation != "" and idType == "II"'>
                        AND A.RSTR_ID = #{operation}
                    </if>
                    <if test='operation != null and operation != "" and idType == "OI"'>
                        AND D.OFCR_EMPNO = #{operation}
                    </if>
                    <if test='operation != null and operation != "" and idType == "SI"'>
                        AND E.SALES_EMP_EMPNO = #{operation}
                    </if>
                    <if test='operation != null and operation != "" and idType == "SL"'>
                        AND C.SALES_OFCR_EMPNO = #{operation}
                    </if>
                    <if test='operation != null and operation != "" and idType == "SO"'>
                        AND C.ORD_OFCR_EMPNO = #{operation}
                    </if>
                    <if test='deptCd != null and deptCd != "" and deptType == "PD"'>
                        AND D.RSLT_DEPT_CD IN (SELECT CD AS ACCTG_DEPT_CD
                                                 FROM (
                                                       SELECT DISTINCT CD
                                                             ,UPPR_CD
                                                         FROM (SELECT CLSS_STRUC_DOMAIN_CD AS CD
                                                                     ,UPPR_CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                 FROM TB_CM_CLSS_STRUC_DOMAIN
                                                                UNION
                                                               SELECT ACCTG_DEPT_CD AS CD
                                                                     ,CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                 FROM TB_CM_ACCTG_DEPT
                                                               )
                                                        WHERE UPPR_CD IN 
                                                                  <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                                #{deptCd}
                                                                  </foreach>
                                                        UNION ALL
                                                       SELECT ACCTG_DEPT_CD
                                                         FROM TB_CM_ACCTG_DEPT
                                                        WHERE ACCTG_DEPT_CD IN
                                                               <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                             #{deptCd}
                                                               </foreach>
                    </if>
                    <if test='deptCd != null and deptCd != "" and deptType == "SD"'>
                        AND E.SELL_BLNG_DEPT_CD IN (SELECT CD AS ACCTG_DEPT_CD
                                                      FROM (
                                                            SELECT DISTINCT CD
                                                                  ,UPPR_CD
                                                              FROM (SELECT CLSS_STRUC_DOMAIN_CD AS CD
                                                                          ,UPPR_CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                      FROM TB_CM_CLSS_STRUC_DOMAIN
                                                                     UNION
                                                                    SELECT ACCTG_DEPT_CD AS CD
                                                                          ,CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                      FROM TB_CM_ACCTG_DEPT
                                                                   )
                                                              WHERE UPPR_CD IN 
                                                                  <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                                #{deptCd}
                                                                  </foreach>
                                                              UNION ALL
                                                             SELECT ACCTG_DEPT_CD
                                                               FROM TB_CM_ACCTG_DEPT
                                                              WHERE ACCTG_DEPT_CD IN
                                                                  <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                                #{deptCd}
                                                                  </foreach>
                    </if>
                    <if test='deptCd != null and deptCd != "" and deptType == "SLD"'>
                        AND E.SALES_CNTRB_DEPT_CD IN (SELECT CD AS ACCTG_DEPT_CD
                                                        FROM (
                                                              SELECT DISTINCT CD
                                                                    ,UPPR_CD
                                                                FROM (SELECT CLSS_STRUC_DOMAIN_CD AS CD
                                                                            ,UPPR_CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                        FROM TB_CM_CLSS_STRUC_DOMAIN
                                                                       UNION
                                                                      SELECT ACCTG_DEPT_CD AS CD
                                                                            ,CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                        FROM TB_CM_ACCTG_DEPT
                                                                     )
                                                                WHERE UPPR_CD IN 
                                                                  <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                                #{deptCd}
                                                                  </foreach>
                                                                UNION ALL
                                                               SELECT ACCTG_DEPT_CD
                                                                 FROM TB_CM_ACCTG_DEPT
                                                                WHERE ACCTG_DEPT_CD IN
                                                                  <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                                #{deptCd}
                                                                  </foreach>
                    </if>
                    <if test='deptCd != null and deptCd != "" and deptType == "OD"'>
                        AND D.EXCT_DEPT_CD IN (SELECT CD AS ACCTG_DEPT_CD
                                                 FROM (
                                                       SELECT DISTINCT CD
                                                             ,UPPR_CD
                                                         FROM (SELECT CLSS_STRUC_DOMAIN_CD AS CD
                                                                     ,UPPR_CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                 FROM TB_CM_CLSS_STRUC_DOMAIN
                                                                UNION
                                                               SELECT ACCTG_DEPT_CD AS CD
                                                                     ,CLSS_STRUC_DOMAIN_CD AS UPPR_CD
                                                                 FROM TB_CM_ACCTG_DEPT
                                                              )
                                                         WHERE UPPR_CD IN 
                                                           <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                         #{deptCd}
                                                           </foreach>
                                                         UNION ALL
                                                        SELECT ACCTG_DEPT_CD
                                                          FROM TB_CM_ACCTG_DEPT
                                                         WHERE ACCTG_DEPT_CD IN
                                                           <foreach collection="deptCdList" item="deptCd" index="index" separator="," open="(" close=")">
                                                                         #{deptCd}
                                                           </foreach>
                    </if>
                    <if test='ccRqstYn != null and ccRqstYn != "" and ccRqstType == "IMP"'>
                        AND IFNULL(A.IMP_CC_RQST_YN, 'N') = #{ccRqstYn}
                    </if>
                    <if test='ccRqstYn != null and ccRqstYn != "" and ccRqstType == "EXP"'>
                        AND IFNULL(A.EXP_CC_RQST_YN, 'N') = #{ccRqstYn}
                    </if>
                    <if test="sendUser != null and sendUser != ''">
                        AND EXISTS (SELECT DAMDANG_NAME
                                      FROM TB_IFTMIN T /* EDI용 SR 데이타를 관리한다 */
                                     WHERE T.SR_NO = (SELECT T2.REF_NO
                                                        FROM TB_FWD_INTG_REF_NO T2
                                                       WHERE T2.INTG_KEY_ID = A.BL_ID)
                                       AND T.DAMDANG_NAME LIKE #{sendUser} || '%' 
                    </if>
                    <if test="taskSprCd != null and taskSprCd != ''">
                        AND D.TASK_SPR_CD = #{taskSprCd}
                    </if>
                    <if test="ordSprCd != null and ordSprCd != ''">
                        AND C.ORD_SPR_CD = #{ordSprCd}
                    </if>
                    <if test='bilgBizptnrCd != null and bilgBizptnrCd != "" and billToSubYn == "N"'>
                        AND E.BILG_BIZPTNR_CD = #{bilgBizptnrCd}
                    </if>
                    <if test='bilgBizptnrCd != null and bilgBizptnrCd != "" and billToSubYn == "Y"'>
                        AND E.BILG_BIZPTNR_CD IN (SELECT X.BIZPTNR_CD
                                                    FROM TB_COM_BIZPTNR X
                                                   WHERE X.USE_YN     = 'Y'
                                                     AND X.BIZPTNR_CD = #{bilgBizptnrCd}
                                                   UNION ALL
                                                  SELECT X.BIZPTNR_CD
                                                    FROM TB_COM_BIZPTNR X
                                                   WHERE X.USE_YN     = 'Y'
                                                     AND X.MBIZPTNR_CD = #{bilgBizptnrCd}
                                                   UNION ALL
                                                  SELECT X.BIZPTNR_CD
                                                    FROM TB_COM_BIZPTNR X
                                                   WHERE X.USE_YN     = 'Y'
                                                     AND X.UPPR_BIZPTNR_CD = #{bilgBizptnrCd})
                    </if>
                    <if test="intmdTxnYn != null and intmdTxnYn != ''">
                        AND C.INTMD_TXN_YN = #{intmdTxnYn}
                    </if>
                    <if test="swtBlYn != null and swtBlYn != ''">
                        AND C.SWT_BL_YN = #{swtBlYn}
                    </if>
                    <if test="lgcSur != null and lgcSur != ''">
                        AND (CASE WHEN A.RMK LIKE '%SURRENDER%' THEN 'Y' ELSE 'N' END) = #{lgcSur}
                    </if>
                    <if test="bizptnrOfcrNm != null and bizptnrOfcrNm != ''">
                        AND (SELECT IP.BIZPTNR_OFCR_NM
                               FROM TB_FWD_INTG_PIC IP
                              WHERE IP.INTG_KEY_ID = A.BL_ID
                                AND IP.DEL_YN      = 'N'
                              LIMIT 1) LIKE CONCAT(#{bizptnrOfcrNm},'%')
                    </if>
                    <if test='mblYn != null and mblYn != "" and mblYn == "Y"'>
                        AND A.MBL_NO IS NOT NULL
                    </if>
                    <if test='mblYn != null and mblYn != "" and mblYn == "N"'>
                        AND A.MBL_NO IS NULL
                    </if>
                    <if test="mblNo != null and mblNo != ''">
                        AND A.MBL_NO = #{mblNo}
                    </if>
                    <if test="rblNo != null and rblNo != ''">
                        AND A.BL_NO = #{rblNo}
                    </if>
                    <if test="blTypeCd != null and blTypeCd != ''">
                        AND H.BL_TYPE_CD = #{blTypeCd}
                    </if>
                    <if test="splitBlYn != null and splitBlYn != ''">
                        AND A.SPLIT_BL_YN = #{splitBlYn}
                    </if>
                    <if test="loclPtnrYn != null and loclPtnrYn != ''">
                        AND A.LOCL_PTNR_YN = #{loclPtnrYn}
                    </if>
                    <if test="destPtnrCd != null and destPtnrCd != ''">
                        AND I.PTNR_CD = #{destPtnrCd}
                    </if>
                    </otherwise>
        </choose>
	          ORDER BY A.EXCT_SPR_CD, A.ONBR_YMD, A.REG_YMD
	           ) MAIN
    </select>

    <!-- 해상HBL CNTR정보 조회 -->
    <select id="selectSeaHblCntrInfo" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectSeaHblCntrInfo */
        SELECT T.CNTR_NO             /* 컨테이너번호     */
              ,T.CNTR_SIZE_CD         /* 컨테이너크기코드 */
              ,(SELECT DTL_CD_NM
                  FROM TB_COM_ETC_CD
                 WHERE CLAS_CD = '0228'
                   AND DTL_CD = T.CNTR_SIZE_CD
                   AND USE_YN ='Y') AS CNTR_SIZE_CD_NM
              ,T.CNTR_TYPE_CD         /* 컨테이너유형코드 */
              ,(SELECT DTL_CD_NM
                  FROM TB_COM_ETC_CD
                 WHERE CLAS_CD = '0232'
                   AND DTL_CD = T.CNTR_TYPE_CD
                   AND USE_YN ='Y') AS CNTR_TYPE_CD_NM
              ,T.FULL_PRTL_SPR_CD
              ,SUBSTR((SELECT DTL_CD_NM
                  FROM TB_COM_ETC_CD
                 WHERE CLAS_CD = '0058'
                   AND DTL_CD = T.CNTR_OWN_TYPE_CD
                   AND USE_YN ='Y'), 1 , 10) AS CNTR_OWN_TYPE_NM
              ,SUBSTR((SELECT DTL_CD_NM
                  FROM TB_COM_ETC_CD
                 WHERE CLAS_CD = '0058'
                   AND DTL_CD = T.CNTR_ADJ_OWN_TYPE_CD
                   AND USE_YN ='Y'), 1 , 10) AS CNTR_ADJ_OWN_TYPE_NM
              ,T.SEAL1
              ,T.SEAL2
              ,T.SEAL3
          FROM TB_FWD_BL_ITEM_MPNG A
    INNER JOIN TB_SMT_INTG_ITEM    T
            ON A.INTG_ITEM_NO = T.INTG_ITEM_NO
         WHERE A.BL_ID = #{blId}
           AND A.DEL_YN = 'N'
           AND T.DEL_YN = 'N'
           AND T.CNTR_YN = 'Y'
           AND A.MPNG_KIND_CD = 'OMI'
      ORDER BY CNTR_NO
    </select>
    
    <!-- 해상HBL CC Request 등록 -->
    <update id="updateSeaHblCCRequest" parameterType="dataItem" >
    /* fwd.document.fwdBlClosMgnt.updateSeaHblCCRequest */
    UPDATE TB_FWD_BL
       SET UPDR_ID = #{session.userId}
          ,UPD_DT = NOW()
      <if test="taskSprCd != null and taskSprCd != '' and taskSprCd == 'EXP'">
          ,EXP_CC_RQST_YN = 'Y'
      </if>
      <if test="taskSprCd != null and taskSprCd != '' and taskSprCd == 'IMP'">
          ,IMP_CC_RQST_YN = 'Y'
      </if>
     WHERE BL_ID = #{blId}
      <if test="taskSprCd != null and taskSprCd != ''">
       AND (#{taskSprCd} = 'EXP' OR #{taskSprCd} = 'IMP')
      </if> 
    </update>
    
    <!-- 해상HBL LIST조회 -->
    <select id="selectSeaHblCloseList" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectSeaHblCloseList */
        SELECT CL.CHK
			  ,CL.SMT_NO
			  ,CL.EO_NO
			  ,CL.BL_NO
			  ,CL.SR_NO
			  ,CL.MBL_NO
			  ,CL.WGT_CLOS_YN
			  ,CL.ONBR_CLOS_YN
			  ,CL.ARR_CLOS_YN
			  ,CL.EXP_CC_RQST_YN
			  ,CL.IMP_CC_RQST_YN
			  ,CL.BL_SPR_CD
              ,CASE WHEN CL.NON_EXCT_BL_YN = 'Y' THEN 'S.DBL' ELSE (SELECT X1.DTL_CD_NM  
                                                                        FROM TB_COM_ETC_CD  X1  
                                                                       WHERE X1.CLAS_CD = '0055'  
                                                                         AND X1.DTL_CD  = CL.BL_SPR_CD 
                                                                         AND X1.USE_YN  = 'Y') END AS BL_SPR_CD_NM
			  ,CL.LADG_TYPE_CD
			  ,CL.LADG_TYPE_CD_NM
			  ,CL.ONBR_YMD
			  ,CL.ARR_YMD
			  ,CL.ARR_UPD
			  ,CL.ETA_YMD
			  ,CL.CARR_GRP_CD
			  ,CL.CARR_NM
			  ,CL.CARR_CD
			  ,CL.CARR_CD_NM
			  ,CL.AGNT_CD
			  ,CL.AGNT_CD_NM
			  ,CL.FLT_VSL_NM
			  ,CL.VOYAGE
			  ,CL.POR_NM
			  ,CL.POL_NM
			  ,CL.POD_NM
			  ,CL.PDEL_NM
			  ,CL.FDEST_NM
			  ,CL.SHPP_CD
			  ,CL.CNEE_CD
			  ,CL.NTPR_CD
			  ,CL.SHPP_NM
			  ,CL.CNEE_NM
			  ,CL.NTPR_NM
			  ,CL.SELL_GWT
			  ,CL.SELL_CBM
			  ,CL.PKG_QTY
			  ,CL.PKG_UNIT_CD
			  ,CL.PKG_UNIT_CD_NM
			  ,CL.CARGO_TYPE_CD
			  ,CL.CARGO_TYPE_CD_NM
			  ,CL.RPRS_REF_NO
			  ,CL.ORGIN_PTNR
			  ,CL.THIRD_PTNR
			  ,CL.ARR_PTNR
			  ,CL.MFCS_ERR_YN
			  ,CL.MFCS_STATUS
			  ,CL.MFCS_ERROR
			  ,CL.BL_ID
			  ,CL.INTG_TASK_NO
			  ,CL.TASK_SPR_CD
			  ,CL.TASK_SPR_CD_NM
			  ,CL.UPDR_ID
			  ,CL.UPD_DT
			  ,CL.EXCT_SPR_CD
			  ,CL.STAT_CD
			  ,CL.ID_TYPE
			  ,CL.PREFIX
			  ,CL.CLOSE_YN
			  ,CL.CLOS_YN
			  ,CL.INCOT_CD
			  ,CL.RPRS_ITEM_NM
			  ,CL.OFCR_EMPNO
			  ,CL.RPA_YN
			  ,CL.OFCR_EMPNM
			  ,CL.SALES_EMP_EMPNO
			  ,CL.ARR_CLOS_AUTO_APLY_YN
			  ,CL.SALES_EMP_EMPNM
			  ,CL.MBL_ID
			  ,CL.BL_SWITCH_YN
			  ,CL.SWT_BL_YN
			  ,CL.CNTR_SIZE20
			  ,CL.CNTR_SIZE40
			  ,CL.MBL_INTG_TASK_NO
			  ,CL.MBL_SMT_NO
			  ,CL.ORD_SPR_CD
			  ,CL.SWITCH_STATUS
			  ,CL.IMP_CORP_CD
			  ,CL.CORP_CD
			  ,CL.ISSUED
			  ,CL.SPLIT_BL_YN
			  ,CL.EL_NO
			  ,CL.BL_PRTN_APRV_YN
			  ,CL.RSLT_CORP_CD
			  ,CL.PGM_ID
			  ,CL.USER_DEPT_CD
			  ,CL.USER_CORP_CD
			  ,CL.USER_MGR_EMPNO
			  ,CL.POR_CD
			  ,CL.POL_CD
			  ,CL.POD_CD
			  ,CL.PDEL_CD
			  ,CL.FDEST_CD
			  ,CL.ERR_MSG
			  ,CL.NON_EXCT_BL_YN
			  ,CL.ORD_SPR_NM
			  ,CL.TRCKG_AUTO_APLY_YN
			  ,CL.FERRY_CARR_YN
			  ,CL.MBL_CLOS_POSB_YN
			  ,CL.STD_DATE
			  ,CL.MSTR_SCHD_APLY_YN
			  ,CL.DATE_GAP
			  ,CL.ROUT_TS1_CD
			  ,CL.TS1_PORT_CD
			  ,CL.ARR_DATE_CHK_SKIP_YN
			  ,CL.GOFF_AREA_NM
			  ,CL.ONBR_RQST_YMD
			  ,CL.ROUT_SPR_CD
			  ,CL.RSLT_DEPT_CD
			  ,CL.RSLT_DEPT_NM
			  ,CL.BL_TYPE_CD
			  ,CL.BL_TYPE_CD_NM
			  ,CL.REG_YMD
			  ,CL.CNTR_LDNG_YN
			  ,CL.RPA_TARGET_YN
              ,IFNULL((SELECT ED.DTL_CD_NM
                         FROM TB_COM_ETC_CD ED
                        WHERE ED.CLAS_CD = '1448'
                          AND ED.USE_YN = 'Y'
                          AND CL.GOFF_AREA_NM LIKE CONCAT('%',ED.DTL_CD_NM,'%')
                        LIMIT 1),CL.GOFF_AREA_NM)  AS GOFF_AREA_CD
          FROM (
                SELECT 'N' AS CHK
                      ,B.SMT_NO
                      ,B.EO_NO
                      ,A.BL_NO
                      ,A.SR_NO
                      ,A.MBL_NO
                      ,A.WGT_CLOS_YN
                      ,IFNULL(A.ONBR_CLOS_YN, 'N') AS ONBR_CLOS_YN
                      ,IFNULL(A.ARR_CLOS_YN, 'N') AS ARR_CLOS_YN
                      ,A.EXP_CC_RQST_YN
                      ,A.IMP_CC_RQST_YN
                      ,A.BL_SPR_CD
                      ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0055'
                           AND DTL_CD  = A.BL_SPR_CD
                           AND USE_YN  = 'Y') AS BL_SPR_CD_NM
                      ,A.LADG_TYPE_CD
                      ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0064'
                           AND DTL_CD  = A.LADG_TYPE_CD
                           AND USE_YN  = 'Y') AS LADG_TYPE_CD_NM
                      ,A.ONBR_YMD
                      ,A.ARR_YMD
                      ,(SELECT CASE WHEN A.ARR_YMD != B.ARR_YMD THEN 'Y' ELSE 'N' END
                          FROM TB_FWD_BL_LOG B
                         WHERE A.BL_ID = B.BL_ID
                           AND (B.BL_ID, B.LOG_SEQ) = (SELECT MIN(BL_ID), MIN(LOG_SEQ) 
                                                         FROM TB_FWD_BL_LOG 
                                                        WHERE BL_ID = A.BL_ID) ) AS ARR_UPD
                                                        
                      /* TODO : VW_VM_SO_TRCKG
                      ,(SELECT FC_FW_GET_BL_TRACK_DT(A.BL_ID, 'POD_ATA', 'YMD') FROM DUAL) AS ETA_YMD
                      */
                      ,'' AS ETA_YMD
                      ,A.CARR_GRP_CD
                      ,A.CARR_NM
                      ,D.CARR_CD
                      ,CASE WHEN (SELECT BIZPTNR_ENG_NM
                                    FROM TB_COM_BIZPTNR
                                   WHERE BIZPTNR_CD = D.CARR_CD) IS NULL THEN (SELECT ETC_CONT1
                                                                                 FROM TB_COM_ETC_CD
                                                                                WHERE CLAS_CD ='1118'
                                                                                  AND DTL_CD_NM = D.CARR_CD) ELSE (SELECT BIZPTNR_ENG_NM
                                                                                                                     FROM TB_COM_BIZPTNR
                                                                                                                    WHERE BIZPTNR_CD = D.CARR_CD)
                       END AS CARR_CD_NM
                      ,D.AGNT_CD
                      ,CASE WHEN (SELECT BIZPTNR_ENG_NM
                                    FROM TB_COM_BIZPTNR
                                   WHERE BIZPTNR_CD = D.AGNT_CD) IS NULL THEN (SELECT ETC_CONT1
                                                                                 FROM TB_COM_ETC_CD
                                                                                WHERE CLAS_CD ='1118'
                                                                                  AND DTL_CD_NM = D.AGNT_CD) ELSE (SELECT BIZPTNR_ENG_NM
                                                                                                                     FROM TB_COM_BIZPTNR
                                                                                                                    WHERE BIZPTNR_CD = D.AGNT_CD)
                       END AS AGNT_CD_NM
                      ,A.FLT_VSL_NM
                      ,A.VOYAGE
                      ,A.POR_NM
                      ,A.POL_NM
                      ,A.POD_NM
                      ,A.PDEL_NM
                      ,A.FDEST_NM
                      ,A.SHPP_CD
                      ,A.CNEE_CD
                      ,A.NTPR_CD
                      ,A.SHPP_NM
                      ,A.CNEE_NM
                      ,A.NTPR_NM
                      ,A.SELL_GWT
                      ,A.SELL_CBM
                      ,A.PKG_QTY
                      ,A.PKG_UNIT_CD
                      ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0134'
                           AND DTL_CD  = A.PKG_UNIT_CD
                           AND USE_YN ='Y') AS PKG_UNIT_CD_NM
                      ,A.CARGO_TYPE_CD
                      ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0077'
                           AND DTL_CD  = A.CARGO_TYPE_CD
                           AND USE_YN ='Y') AS CARGO_TYPE_CD_NM
                      ,A.RPRS_REF_NO
                      ,(SELECT (SELECT CORP_ACRN_NM5
                                  FROM TB_COM_CORP
                                 WHERE CORP_CD = T.EXCT_BIZPTNR_CD)
                          FROM TB_SMT_INTG_TASK_DEPT T
                         WHERE B.EO_NO = T.EO_NO
                           AND T.TASK_SPR_CD = 'EXP'
                           AND T.DEL_YN = 'N'
                         LIMIT 1) AS ORGIN_PTNR
                      ,(SELECT (SELECT CORP_ACRN_NM5
                                  FROM TB_COM_CORP
                                 WHERE CORP_CD = T.EXCT_BIZPTNR_CD)
                          FROM TB_SMT_INTG_TASK_DEPT T
                         WHERE B.EO_NO = T.EO_NO
                           AND T.TASK_SPR_CD = 'TRD'
                           AND T.DEL_YN = 'N'
                         LIMIT 1) AS THIRD_PTNR
                      ,(SELECT (SELECT CORP_ACRN_NM5
                                  FROM TB_COM_CORP
                                 WHERE CORP_CD = T.EXCT_BIZPTNR_CD)
                          FROM TB_SMT_INTG_TASK_DEPT T
                         WHERE B.EO_NO = T.EO_NO
                           AND T.TASK_SPR_CD = 'IMP'
                           AND T.DEL_YN = 'N'
                         LIMIT 1) AS ARR_PTNR
                      ,CASE WHEN (SELECT T.REMARK
                                    FROM NFINF.TB_FWD_INT5040 T
                                   WHERE T.HBL_NO = A.BL_NO
                                     AND T.RES_SEQ = (SELECT S.RES_SEQ
                                                        FROM NFINF.TB_FWD_INT5040 S
                                                       WHERE S.HBL_NO = T.HBL_NO
                                                       LIMIT 1)) IS NULL THEN 'Y' ELSE 'N' END AS MFCS_ERR_YN
                      ,(SELECT (SELECT Y.DTL_CD_NM FROM TB_COM_ETC_CD Y WHERE Y.CLAS_CD = '0217' AND Y.DTL_CD = T.STATUS)
                          FROM NFINF.TB_FWD_INT5040 T
                         WHERE T.HBL_NO = A.BL_NO
                           AND T.RES_SEQ = (SELECT S.RES_SEQ
                                              FROM NFINF.TB_FWD_INT5040 S
                                             WHERE S.HBL_NO = T.HBL_NO
                                             LIMIT 1)
                         LIMIT 1) AS MFCS_STATUS
                      ,(SELECT T.REMARK
                          FROM NFINF.TB_FWD_INT5040 T
                         WHERE T.HBL_NO = A.BL_NO
                           AND T.RES_SEQ = (SELECT S.RES_SEQ
                                              FROM NFINF.TB_FWD_INT5040 S
                                             WHERE S.HBL_NO = T.HBL_NO
                                             LIMIT 1)
                         LIMIT 1) AS MFCS_ERROR
                      ,A.BL_ID
                      ,D.INTG_TASK_NO
                      ,D.TASK_SPR_CD
                      ,(SELECT DTL_CD_NM
                          FROM TB_COM_ETC_CD
                         WHERE CLAS_CD = '0031'
                           AND DTL_CD  = D.TASK_SPR_CD
                           AND USE_YN ='Y') AS TASK_SPR_CD_NM
                      ,A.UPDR_ID
                      ,A.UPD_DT
                      ,A.EXCT_SPR_CD
                      ,'' AS STAT_CD
                      ,'' AS ID_TYPE
                      ,'' AS PREFIX
                      ,'' AS CLOSE_YN
                      ,'' AS CLOS_YN
                      ,A.INCOT_CD
                      ,A.RPRS_ITEM_NM
                      ,D.OFCR_EMPNO
                      ,CASE WHEN EXISTS (SELECT 1 FROM TB_COM_EMP 
                                          WHERE EMP_NM = 'RPA'
                                            AND USE_YN = 'Y'
                                            AND EMPNO = IFNULL((SELECT UPDR_ID 
                                                                  FROM TB_FWD_BL_LOG BL_LOG
                                                                 WHERE BL_ID = A.BL_ID 
                                                                   AND ONBR_CLOS_YN = A.ONBR_CLOS_YN 
                                                                   AND BL_STAT_CD   = (CASE WHEN #{closeType} = 'OC' THEN '300' WHEN #{closeType} = 'AC' THEN '320' ELSE '300' END)
                                                                   AND DEL_YN = 'N'
                                                                 LIMIT 1), 'X')
                                        ) THEN 'Y' ELSE 'N' END AS RPA_YN
                      ,(SELECT ENG_EMP_NM
                          FROM TB_COM_EMP
                         WHERE EMPNO = D.OFCR_EMPNO) AS OFCR_EMPNM
                      ,E.SALES_EMP_EMPNO
                      ,IFNULL(F.ARR_CLOS_AUTO_APLY_YN, 'N') AS ARR_CLOS_AUTO_APLY_YN
                      ,(SELECT ENG_EMP_NM
                          FROM TB_COM_EMP
                         WHERE EMPNO = E.SALES_EMP_EMPNO) AS SALES_EMP_EMPNM
                      ,CASE WHEN A.BL_SWITCH_YN = 'Y' THEN (SELECT MBL_ID
                                                              FROM TB_FWD_BL A
                                                             WHERE DEL_YN  = 'N'
                                                               AND IFNULL(A.BL_SWITCH_YN, 'N') = 'N'
                                                               AND BL_ID = (SELECT ORIGN_BL_ID
                                                                              FROM TB_FWD_BL
                                                                             WHERE  BL_ID = A.BL_ID )) 
                            ELSE A.MBL_ID END AS MBL_ID
        
                      ,IFNULL(A.BL_SWITCH_YN, 'N') AS BL_SWITCH_YN
                      ,IFNULL(C.SWT_BL_YN, 'N') AS SWT_BL_YN
                      ,(SELECT COUNT(1)
                          FROM TB_FWD_BL_ITEM_MPNG X
                    INNER JOIN TB_SMT_INTG_ITEM    T
                            ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                         WHERE X.BL_ID = A.BL_ID
                           AND X.DEL_YN = 'N'
                           AND T.DEL_YN = 'N'
                           AND T.CNTR_YN = 'Y'
                           AND X.MPNG_KIND_CD = 'OMI'
                           AND T.CNTR_SIZE_CD = '20'
                           AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') CNTR_SIZE20
                      ,(SELECT COUNT(1)
                          FROM TB_FWD_BL_ITEM_MPNG X
                    INNER JOIN TB_SMT_INTG_ITEM    T
                            ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                         WHERE X.BL_ID = A.BL_ID
                           AND X.DEL_YN = 'N'
                           AND T.DEL_YN = 'N'
                           AND T.CNTR_YN = 'Y'
                           AND X.MPNG_KIND_CD = 'OMI'
                           AND T.CNTR_SIZE_CD = '40'
                           AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') CNTR_SIZE40
                      ,SUBSTR((<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetMblTaskNo">
		                           <property name="blId" value="A.BL_ID"></property>
		                           <property name="intgTaskNo" value="D.INTG_TASK_NO"></property>
		                       </include>),0, 100) AS MBL_INTG_TASK_NO
                      ,(SELECT X.SMT_NO
                          FROM TB_FWD_BL X
                         WHERE X.BL_ID = (CASE WHEN IFNULL(A.BL_SWITCH_YN, 'N') = 'Y' THEN (SELECT MBL_ID
                                                                                              FROM TB_FWD_BL A
                                                                                             WHERE DEL_YN  = 'N'
                                                                                               AND IFNULL(A.BL_SWITCH_YN, 'N') = 'N'
                                                                                               AND BL_ID = (SELECT ORIGN_BL_ID
                                                                                                              FROM TB_FWD_BL
                                                                                                             WHERE BL_ID = A.BL_ID ))
                                               ELSE A.MBL_ID END)) AS MBL_SMT_NO
                      ,C.ORD_SPR_CD
                      ,(SELECT DTL_CD_NM
                                 FROM TB_COM_ETC_CD
                                WHERE CLAS_CD = '0514'
                                  AND DTL_CD  = (<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetSwitchInfo">
                                                   <property name="blId" value="A.BL_ID"></property>
                                                 </include>)
                                  AND USE_YN ='Y') AS SWITCH_STATUS
                      ,(SELECT X.EXCT_BIZPTNR_CD
                          FROM TB_SMT_INTG_TASK_DEPT X
                         WHERE 1=1
                           AND A.EO_NO = X.EO_NO
                           AND A.BL_ID = X.CST_BL_ID
                           AND X.DEL_YN = 'N'
                           AND X.TASK_SPR_CD = 'IMP') AS IMP_CORP_CD
                      ,#{bizptnrCd} AS CORP_CD
                      ,CASE WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'N' THEN 'PROCESSING' WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'Y' THEN 'ISSUED' END AS ISSUED
                      ,IFNULL(A.SPLIT_BL_YN, 'N') AS SPLIT_BL_YN
                      ,(SELECT GROUP_CONCAT(CONCAT(EXP_LICE_NO, '/') ORDER BY BL_ID, LICE_SEQ)
                          FROM TB_FWD_BL_EXP_LICE X
                         WHERE X.BL_ID = A.BL_ID
                           AND X.DEL_YN = 'N') AS EL_NO
                      ,(SELECT CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN 'Y' ELSE (CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END) END
                          FROM TB_FWD_BL_PRT_APRV Y
                    INNER JOIN TB_FWD_BL_PRT_APRV_DTL Z
                            ON Y.RQST_SEQ = Z.RQST_SEQ 
                         WHERE Y.APRV_REQR_ID = #{userId}
                           AND Y.STEP_CD = '7777'
                           AND Z.BL_ID = A.BL_ID ) AS BL_PRTN_APRV_YN
                      ,D.EXCT_BIZPTNR_CD AS RSLT_CORP_CD
                      ,'' AS PGM_ID
                      ,(SELECT Z.DEPT_CD
                          FROM TB_COM_EMP Z
                         WHERE Z.EMPNO = #{userId} ) AS USER_DEPT_CD
                      ,(SELECT Z.CORP_CD
                          FROM TB_COM_EMP Z
                         WHERE Z.EMPNO = #{userId} ) AS USER_CORP_CD
                      ,(SELECT B.MGR_EMPNO
                          FROM TB_COM_EMP A
                    INNER JOIN TB_COM_HR_DEPT B
                            ON A.DEPT_CD = B.DEPT_CD
                           AND A.HR_COM_CD = B.HR_COM_CD
                         WHERE A.EMPNO = #{userId} ) AS USER_MGR_EMPNO
                      ,A.POR_CD
                      ,A.POL_CD
                      ,A.POD_CD
                      ,A.PDEL_CD
                      ,A.FDEST_CD
                      ,'' ERR_MSG
                      ,A.NON_EXCT_BL_YN
                      ,(SELECT X.DTL_CD_NM
                          FROM TB_COM_ETC_CD X
                         WHERE X.CLAS_CD = '0219'
                           AND X.DTL_CD = C.ORD_SPR_CD
                           AND X.USE_YN = 'Y') AS ORD_SPR_NM
                      ,IFNULL(F.TRCKG_AUTO_APLY_YN, 'N') TRCKG_AUTO_APLY_YN
                      ,(SELECT IFNULL(CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END, 'N')
                          FROM TB_FWD_BL AX
                    INNER JOIN TB_SMT_INTG_TASK_DEPT BX
                            ON AX.BL_ID = BX.CST_BL_ID
                           AND AX.EO_NO = BX.EO_NO
                    INNER JOIN TB_COM_BIZPTNR_KIND CX
                            ON BX.CARR_CD = CX.BIZPTNR_CD 
                         WHERE AX.BL_ID = A.BL_ID
                           AND AX.DEL_YN = 'N'
                           AND BX.DEL_YN = 'N'
                           AND BX.TASK_SPR_CD = D.TASK_SPR_CD
                           AND CX.BIZPTNR_KIND_CD = 'V150')  AS FERRY_CARR_YN
                      ,IFNULL((SELECT CASE WHEN X.OFCR_EMPNO IS NULL OR X.OFCR_EMPNO = '' THEN 'N'
                                           WHEN X.EXCT_DEPT_CD IS NULL OR X.EXCT_DEPT_CD = '' THEN 'N'
                                           WHEN X.CARR_CD IS NULL OR X.CARR_CD = '' THEN 'N'
                                           WHEN X.AGNT_CD IS NULL OR X.AGNT_CD = '' THEN 'N'
                                      ELSE 'Y' END
                                 FROM TB_SMT_INTG_TASK_DEPT X
                                WHERE X.INTG_TASK_NO = (<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetMblTaskNo">
                                                             <property name="blId" value="A.BL_ID"></property>
                                                             <property name="intgTaskNo" value="D.INTG_TASK_NO"></property>
                                                         </include>)
                                  AND X.DEL_YN = 'N'), 'Y') AS MBL_CLOS_POSB_YN
                      /* TODO : TB_VM_TRCKG_ROUT_MSTR
                      ,(SELECT TO_CHAR(TO_DATE(A.ONBR_YMD, 'YYYYMMDD') + IFNULL(POL_POD_LDTM_DCNT, 0), 'YYYYMMDD')
                          FROM TB_VM_TRCKG_ROUT_MSTR
                         WHERE POL_CD = A.POL_CD
                           AND POD_CD = A.POD_CD
                           AND CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                           AND DEL_YN = 'N'
                           AND ROWNUM = 1
                        ) AS STD_DATE
                      */
                      ,'' AS STD_DATE
                      /* TODO : TB_VM_TRCKG_ROUT_MSTR
                      ,(SELECT MSTR_SCHD_APLY_YN
                        FROM   TB_VM_TRCKG_ROUT_MSTR
                        WHERE  POL_CD = A.POL_CD
                        AND    POD_CD = A.POD_CD
                        AND    CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                        AND    DEL_YN = 'N'
                        AND    ROWNUM = 1
                        ) AS MSTR_SCHD_APLY_YN
                      */
                      ,'' AS MSTR_SCHD_APLY_YN
                      /* TODO : TB_VM_TRCKG_ROUT_MSTR
                      ,TO_DATE(A.ARR_YMD, 'YYYYMMDD') - TO_DATE((SELECT TO_CHAR(TO_DATE(A.ONBR_YMD, 'YYYYMMDD') + IFNULL(POL_POD_LDTM_DCNT, 0), 'YYYYMMDD')
                                                                 FROM   TB_VM_TRCKG_ROUT_MSTR
                                                                 WHERE  POL_CD = A.POL_CD
                                                                 AND    POD_CD = A.POD_CD
                                                                 AND    CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                                                                 AND    DEL_YN = 'N'
                                                                 AND    ROWNUM = 1), 'YYYYMMDD') AS DATE_GAP
                      */
                      ,'' AS DATE_GAP
                      /* TODO : TB_VM_TRCKG_ROUT_MSTR
                      ,(SELECT TS1_CD
                          FROM TB_VM_TRCKG_ROUT_MSTR AA
                    INNER JOIN TB_OM_INTG_TASK_DEPT BB 
                         WHERE AA.POL_CD = A.POL_CD
                           AND AA.POD_CD = A.POD_CD
                           AND AA.CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(BB.CARR_CD) FROM DUAL)
                           AND AA.DEL_YN = 'N'
                           AND BB.DEL_YN = 'N'
                           AND BB.CST_BL_ID = A.BL_ID
                           AND BB.TASK_SPR_CD = 'EXP'
                         LIMIT 1) AS ROUT_TS1_CD
                      */
                      ,'' AS ROUT_TS1_CD
                      ,F.TS1_PORT_CD
                      ,(SELECT IFNULL(CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END, 'N')
                          FROM TB_FWD_BL AX
                    INNER JOIN TB_SMT_INTG_TASK_DEPT BX
                            ON AX.BL_ID = BX.CST_BL_ID
                           AND AX.EO_NO = BX.EO_NO
                    INNER JOIN TB_COM_ETC_CD CX
                            ON BX.CARR_CD = CX.RMK_CONT
                         WHERE AX.BL_ID = A.BL_ID
                           AND AX.DEL_YN = 'N'
                           AND BX.DEL_YN = 'N'
                           AND BX.TASK_SPR_CD = D.TASK_SPR_CD
                           AND CX.CLAS_CD = '1321'
                           AND CX.USE_YN = 'Y')  AS ARR_DATE_CHK_SKIP_YN
                      ,(SELECT BK.GOFF_AREA_NM
                          FROM TB_SMT_BK_EXPND BK
                         WHERE BK.CORP_CD = #{bizptnrCd}
                           AND BK.SHIPLN_BKNG_NO = A.SHIPLN_BKNG_NO
                           AND BK.DEL_YN = 'N'
                         LIMIT 1)  AS GOFF_AREA_NM
                      ,C.ONBR_RQST_YMD  /* 출항요청일자 */
                      ,A.ROUT_SPR_CD
        
                      ,D.RSLT_DEPT_CD
                      ,(SELECT ACCTG_DEPT_ENG_NM
                          FROM TB_COM_ACCTG_DEPT
                         WHERE ACCTG_DEPT_CD = D.RSLT_DEPT_CD) AS RSLT_DEPT_NM
        
                      ,G.BL_TYPE_CD
                      ,(SELECT X.DTL_CD_NM
                          FROM TB_COM_ETC_CD X
                         WHERE X.CLAS_CD = '1158'
                           AND X.DTL_CD = G.BL_TYPE_CD
                           AND X.USE_YN = 'Y') AS BL_TYPE_CD_NM
                      ,A.REG_YMD
                      ,CASE WHEN EXISTS(SELECT 1 
                                          FROM TB_FWD_BL AA
                                    INNER JOIN TB_SEA_CNTR_LDNG BB
                                            ON AA.BL_NO = BB.BL_NO
                                    INNER JOIN TB_SMT_INTG_ITEM CC
                                            ON AA.SMT_NO = CC.SMT_NO
                                           AND BB.CNTR_NO = CC.CNTR_NO
                                         WHERE CC.CNTR_YN = 'Y'                                                        
                                           AND AA.BL_ID = A.BL_ID
                                           AND AA.BL_NO = A.BL_NO
                                           AND AA.DEL_YN = 'N'
                                           AND CC.DEL_YN = 'N'
                                         LIMIT 1) THEN 'Y' 
                       ELSE 'N' 
                       END AS CNTR_LDNG_YN
                      ,CASE WHEN EXISTS(SELECT 1 
                                          FROM TB_SEA_RPT_TARGET AA  
                                         WHERE AA.USE_YN = 'Y'
                                           AND AA.SHPP_CD = A.SHPP_CD                                        
                                           AND AA.EXCT_DEPT_CD = D.EXCT_DEPT_CD
                                         LIMIT 1) THEN 'Y'  
                            ELSE 'N' 
                       END AS RPA_TARGET_YN
                  FROM TB_FWD_BL             A
            INNER JOIN TB_FWD_BL_EXPND       F
                    ON A.BL_ID = F.BL_ID
            INNER JOIN TB_SMT_EO             B
                    ON A.EO_NO = B.EO_NO
            INNER JOIN TB_SMT_ORD            C
                    ON A.SMT_NO = C.SMT_NO
            INNER JOIN TB_SMT_INTG_TASK_DEPT D
                    ON A.BL_ID = D.CST_BL_ID
                   AND B.EO_NO = D.EO_NO
       LEFT OUTER JOIN TB_SMT_ORD_SELL_BILG  E
                    ON A.SMT_NO = E.SMT_NO
       LEFT OUTER JOIN TB_FWD_BL_PRT_EXPND   G
                    ON A.BL_ID = G.BL_ID
                 WHERE D.EXCT_BIZPTNR_CD = #{bizptnrCd}
                   AND E.SELL_BIZPTNR_CD = #{bizptnrCd}
                   AND A.DEL_YN = 'N'
                   AND B.DEL_YN = 'N'
                   AND D.DEL_YN = 'N'
                   AND A.BL_NO IS NOT NULL
                   AND 1 = (CASE WHEN A.SPLIT_BL_YN = 'Y' AND A.MBL_ID IS NULL THEN CASE WHEN #{includeSplitYn} = 'Y' THEN 1 ELSE 2 END
                                 WHEN A.BL_SPR_CD = 'H' AND A.BL_SWITCH_YN = 'N' AND A.MBL_ID IS NULL  THEN 2
                                 ELSE 1
                                 END)
            <if test='exctSprCd == null or exctSprCd == ""'>
                   AND A.EXCT_SPR_CD = 'OC'
                   AND A.BL_SPR_CD IN ('H', 'D')
            </if>
            <choose>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "BL"'> 
                   AND A.BL_NO IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "EO"'>
                   AND A.EO_NO IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "SMT"'>
                   AND A.SMT_NO IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "SR"'>
                   AND A.SR_NO IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "MBL"'>
                   AND A.MBL_NO
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>                        
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "VSL"'>
                   AND A.FLT_VSL_NM IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <when test='directSearchNo != null and directSearchNo != "" and directSearchNoList != null and directSearchType == "LNBKNG"'>
                   AND A.SHIPLN_BKNG_NO IN
                                   <foreach collection="directSearchNoList" item="directSearchNo" index="index" separator="," open="(" close=")">
                                            #{directSearchNo}
                                   </foreach>
               </when>
               <otherwise>
               <if test="blno != null and blno != '' and noType == 'BL'">
                   AND A.BL_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>
               <if test="blno != null and blno != '' and noType == 'EO'">
                   AND A.EO_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>
               <if test="blno != null and blno != '' and noType == 'SMT'">
                   AND A.SMT_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>
               <if test="blno != null and blno != '' and noType == 'SR'">
                   AND A.SR_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>
               <if test="blno != null and blno != '' and noType == 'MBL'">
                   AND A.MBL_NO
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>                        
               </if>
               <if test="blno != null and blno != '' and noType == 'VSL'">
                   AND A.FLT_VSL_NM IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>
               <if test="blno != null and blno != '' and noType == 'LNBKNG'">
                   AND A.SHIPLN_BKNG_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </if>

                 <if test='closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "OC"'>
                   AND C.ORD_SPR_CD IN ('10', '50')
                   AND D.TASK_SPR_CD = 'EXP'
                 </if>
                 <if test='closeYn != null and closeYn != "" and closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "OC"'>
                   AND A.ONBR_CLOS_YN = #{closeYn}
                 </if>
                 <if test='closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "AC"'>
                   AND C.ORD_SPR_CD  = '10'
                   AND 1 = (CASE WHEN A.BL_SPR_CD = 'H' AND D.TASK_SPR_CD = 'IMP' AND IFNULL(A.ONBR_CLOS_YN, 'N') = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'H' AND IFNULL(A.LOCL_PTNR_YN, 'N') = 'Y' AND D.TASK_SPR_CD IN ('EXP', 'IMP') AND A.ONBR_CLOS_YN = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'D' AND IFNULL(A.ONBR_CLOS_YN, 'N') = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'D' AND IFNULL(A.LOCL_PTNR_YN, 'N') = 'Y' AND D.TASK_SPR_CD IN ('EXP', 'IMP') THEN 1
                                 ELSE 2
                            END)
                 </if>
                 <if test='closeYn != null and closeYn != "" and closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "AC"'>
                   AND A.ARR_CLOS_YN = #{closeYn}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "OB"'>
                   AND A.ONBR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "AR"'>
                   AND A.ARR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "EO"'>
                   AND B.REG_DT BETWEEN STR_TO_DATE(#{udc_fromToCal_from}, '%Y-%m-%d') AND STR_TO_DATE(#{udc_fromToCal_to}, '%Y-%m-%d') + 1
                 </if>
                 <if test='closeType != null and closeType != "" and closeType == "HB" and closeYn == "Y"'>
                   AND (A.BL_NO IS NULL OR A.BL_NO = '')
                 </if>
                 <if test='closeType != null and closeType != "" and closeType == "HB" and closeYn == "N"'>
                   AND A.BL_NO IS NOT NULL
                 </if>
                 <if test="blSprCd != null and blSprCd != ''">
                   AND A.BL_SPR_CD = #{blSprCd}
                 </if>
                 <if test="nonExctBlYn != null and nonExctBlYn != ''">
                   AND A.NON_EXCT_BL_YN = #{nonExctBlYn}
                 </if>
                 <if test="exctSprCd != null and exctSprCd != ''">
                   AND A.EXCT_SPR_CD = #{exctSprCd}
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "PO"'>
                   AND A.POR_CD = #{porCd}
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POR_CD
                                  AND X.NATN_CD = #{porCd})
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POR_CD, 1, 2)
                                  AND X.REGN_CD = #{porCd})
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "PO"'>
                   AND A.POL_CD = #{porCd}
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POL_CD
                                  AND X.NATN_CD = #{polCd})
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POL_CD, 1, 2)
                                  AND X.REGN_CD = #{polCd})
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "PO"'>
                   AND A.POD_CD = #{podCd}
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POD_CD
                                  AND X.NATN_CD = #{podCd})
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POD_CD, 1, 2)
                                  AND X.REGN_CD = #{podCd})
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "PD"'>
                   AND A.PDEL_CD = #{pdelCd}
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.PDEL_CD
                                  AND X.NATN_CD = #{pdelCd})
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.PDEL_CD, 1, 2)
                                  AND X.REGN_CD = #{pdelCd})
                 </if>
                 <if test='lnCd != null and lnCd != ""'>
                   AND D.CARR_CD = #{lnCd}
                 </if>
                 <if test='agntCd != null and agntCd != ""'>
                   AND D.AGNT_CD = #{agntCd}
                 </if>
                 <if test='shprCd != null and shprCd != ""'>
                   AND A.SHPP_CD = #{shprCd}
                 </if>
                 <if test='cneeCd != null and cneeCd != ""'>
                   AND A.CNEE_CD = #{cneeCd}
                 </if>
                 <if test='ntprCd != null and ntprCd != ""'>
                   AND A.NTPR_CD = #{ntprCd}
                 </if>
                 <if test='refno != null and refno != ""'>
                   AND EXISTS (SELECT 1
                                 FROM TB_FWD_INTG_REF_NO   X
                                WHERE X.DEL_YN = 'N'
                                  AND X.INTG_KEY_ID = A.BL_ID
                                  AND X.REF_NO_SPR_CD = IFNULL(#{refnoType}, X.REF_NO_SPR_CD)
                                  AND X.REF_NO = #{refno})
                 </if>
                 <if test='blSwitchYn != null and blSwitchYn != ""'>
                   AND A.BL_SWITCH_YN = #{blSwitchYn}
                 </if>
                 <if test='oblYn != null and oblYn != ""'>
                   AND IFNULL(A.ORIGN_PRNT_YN, 'N') = #{oblYn}
                 </if>
                 <if test='loadType != null and loadType != ""'>
                   AND A.LADG_TYPE_CD = #{loadType}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "IT"'>
                   AND A.RSTR_ID = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "OI"'>
                   AND D.OFCR_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "SI"'>
                   AND E.SALES_EMP_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "OR"'>
                   AND C.ORD_OFCR_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "SL"'>
                   AND C.SALES_OFCR_EMPNO = #{operationId}
                 </if>
		         <if test='cntrLdngYn != null and cntrLdngYn != "" and cntrLdngYn == "Y"'>
		           AND EXISTS (SELECT 1 
		                         FROM TB_FWD_BL AA
		                   INNER JOIN TB_SEA_CNTR_LDNG BB
		                           ON AA.BL_NO = BB.BL_NO
		                   INNER JOIN TB_SMT_INTG_ITEM CC
		                           ON AA.SMT_NO = CC.SMT_NO
		                          AND BB.CNTR_NO = CC.CNTR_NO
		                        WHERE CC.CNTR_YN = 'Y'                                                        
		                          AND AA.BL_ID = A.BL_ID
		                          AND AA.BL_NO = A.BL_NO
		                          AND AA.DEL_YN = 'N'
		                          AND CC.DEL_YN = 'N'
		                        LIMIT 1) 
		         </if>
		         <if test='cntrLdngYn != null and cntrLdngYn != "" and cntrLdngYn == "N"'>
		          AND NOT EXISTS (SELECT 1 
		                            FROM TB_FWD_BL AA
		                      INNER JOIN TB_SEA_CNTR_LDNG BB
		                              ON AA.BL_NO = BB.BL_NO
		                      INNER JOIN TB_SMT_INTG_ITEM CC
		                              ON AA.SMT_NO = CC.SMT_NO
		                             AND BB.CNTR_NO = CC.CNTR_NO 
		                           WHERE CC.CNTR_YN = 'Y'                                                        
		                             AND AA.BL_ID = A.BL_ID
		                             AND AA.BL_NO = A.BL_NO
		                             AND AA.DEL_YN = 'N'
		                             AND CC.DEL_YN = 'N'
		                           LIMIT 1) 
		         </if>
		         <if test='rpaTargetYn != null and rpaTargetYn != "" and rpaTargetYn == "Y"'>
		          AND EXISTS (SELECT 1 
		                        FROM TB_SEA_RPT_TARGET AA  
		                       WHERE AA.USE_YN = 'Y'
		                         AND AA.SHPP_CD = A.SHPP_CD                                        
		                         AND AA.EXCT_DEPT_CD = D.EXCT_DEPT_CD
		                       LIMIT 1)
		         </if>
		         <if test='rpaTargetYn != null and rpaTargetYn != "" and rpaTargetYn == "N"'>
		          AND NOT EXISTS (SELECT 1 
		                            FROM TB_SEA_RPT_TARGET AA  
		                           WHERE AA.USE_YN = 'Y'
		                             AND AA.SHPP_CD = A.SHPP_CD                                        
		                             AND AA.EXCT_DEPT_CD = D.EXCT_DEPT_CD
		                           LIMIT 1)
		         </if>
                 <if test='histPodEtaYmdYn != null and histPodEtaYmdYn != ""'>
                  AND IFNULL(F.HIST_POD_ETA_YMD_YN,'N') = #{histPodEtaYmdYn}
                 </if>
               </otherwise>
            </choose>
               ) CL
          WHERE 1 = 1
       ORDER BY CL.EXCT_SPR_CD, CL.ONBR_YMD, CL.REG_YMD
    </select>
    
    <!-- 스케줄 저장 키 조회 -->
    <select id="selectTnScheduleKey" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectTnScheduleKey */
        SELECT LPAD(IFNULL(MAX(FILE_SEQ), 0) + 1, 6, '0') AS FILE_SEQ
          FROM TB_SEA_UPLOAD_TN_SCHEDULE
    </select>
    
    <!-- 해상HBL LIST조회 For Tracking -->
    <select id="selectSeaHblCloseTrackingList" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectSeaHblCloseTrackingList */
        SELECT A.*
              ,(SELECT CASE WHEN A.ARR_YMD != B.ARR_YMD THEN 'Y' ELSE 'N' END
                  FROM TB_FWD_BL_LOG B
                 WHERE B.BL_ID   = A.BL_ID
                   AND B.LOG_SEQ = (SELECT MIN(LOG_SEQ) 
                                      FROM TB_FWD_BL_LOG 
                                     WHERE BL_ID = A.BL_ID) ) AS ARR_UPD
              ,(SELECT X1.ENG_EMP_NM 
                  FROM TB_COM_EMP X1 
                 WHERE X1.EMPNO = SBK_OPRT_ID ) AS SBK_OPRT_NM  
              ,(SELECT EMAIL_ADDR 
                  FROM TB_COM_EMP
                 WHERE EMPNO = SBK_OPRT_ID
                 LIMIT 1) AS SBK_OPRT_EMAIL_ADDR
              ,(CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN A.ARRV_PRAR_GAP_DCNT ELSE ( CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                   <property name="blId" value="A.BL_ID"></property>
                                                                                          </include>) = 'Y' THEN 0
                                                                                     ELSE ( CASE WHEN ABS(IFNULL(A.DATE_GAP,0)) >  ABS(IFNULL(A.HIS_DATE_GAP,0)) THEN DATE_GAP
                                                                                                 WHEN ABS(IFNULL(A.DATE_GAP,0)) <![CDATA[<]]> ABS(IFNULL(A.HIS_DATE_GAP,0)) THEN HIS_DATE_GAP
                                                                                                 WHEN IFNULL(A.DATE_GAP,0) > IFNULL(A.HIS_DATE_GAP,0)           THEN DATE_GAP
                                                                                                 ELSE IFNULL(A.HIS_DATE_GAP, 0) END)
                                                                                END ) END) AS ETA_GAP
              ,(CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN A.ARRV_PRAR_GAP_CLR_NM ELSE (CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                     <property name="blId" value="A.BL_ID"></property>
                                                                                            </include>) = 'Y' THEN 'WHITE'
                                                                                      ELSE (CASE WHEN GREATEST(ABS(IFNULL(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                                                              <property name="blId" value="A.BL_ID"></property>
                                                                                                                                     </include>) = 'Y' OR IFNULL(A.POL_POD_LDTM_DCNT, 0) = 0 THEN '' 
                                                                                                                               ELSE (STR_TO_DATE(A.ONBR_YMD, '%Y%m%d') + IFNULL(A.POL_POD_LDTM_DCNT, 0) - STR_TO_DATE(A.ARR_YMD, '%Y%m%d'))
                                                                                                                          END,0)), ABS(IFNULL(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                                                                                  <property name="blId" value="A.BL_ID"></property>
                                                                                                                                                         </include>) = 'Y' OR IFNULL(A.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN '' 
                                                                                                                                                   ELSE (STR_TO_DATE(A.ONBR_YMD, '%Y%m%d') + IFNULL(A.MAX_FRQNY_LDTM_DCNT, 0) - STR_TO_DATE(A.ARR_YMD, '%Y%m%d'))
                                                                                                                                              END,0))) >= 3 THEN 'RED'
                                                                                                 WHEN GREATEST(ABS(IFNULL(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                                                              <property name="blId" value="A.BL_ID"></property>
                                                                                                                                     </include>) = 'Y' OR IFNULL(A.POL_POD_LDTM_DCNT, 0) = 0 THEN '' 
                                                                                                                               ELSE (STR_TO_DATE(A.ONBR_YMD, '%Y%m%d') + IFNULL(A.POL_POD_LDTM_DCNT, 0) - STR_TO_DATE(A.ARR_YMD, '%Y%m%d'))
                                                                                                                          END,0)), ABS(IFNULL(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                                                                                  <property name="blId" value="A.BL_ID"></property>
                                                                                                                                                         </include>) = 'Y' OR IFNULL(A.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN '' 
                                                                                                                                                   ELSE (STR_TO_DATE(A.ONBR_YMD, '%Y%m%d') + IFNULL(A.MAX_FRQNY_LDTM_DCNT, 0) - STR_TO_DATE(A.ARR_YMD, '%Y%m%d'))
                                                                                                                                              END,0))) >= 2 THEN 'YELLOW'
                                                                                                 ELSE 'WHITE'
                                                                                            END )
                                                                                 END )
                END) AS ETA_GAP_COLOR
              ,(CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN A.REF_LDTM_DCNT ELSE ( CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                               <property name="blId" value="A.BL_ID"></property>
                                                                                      </include>) = 'Y' THEN ''
                                                                                ELSE STR_TO_DATE(A.ARR_YMD, '%Y%m%d') + IFNULL((CASE WHEN ABS(IFNULL(A.DATE_GAP, 0)) > ABS(IFNULL(A.HIS_DATE_GAP, 0)) THEN DATE_GAP
                                                                                                                                     WHEN ABS(IFNULL(A.DATE_GAP, 0)) <![CDATA[<]]> ABS(IFNULL(A.HIS_DATE_GAP, 0)) THEN HIS_DATE_GAP
                                                                                                                                     WHEN IFNULL(A.DATE_GAP, 0) > IFNULL(A.HIS_DATE_GAP, 0)           THEN DATE_GAP
                                                                                                                                     ELSE IFNULL(A.HIS_DATE_GAP, 0) END),0) - STR_TO_DATE(A.ONBR_YMD, '%Y%m%d')
                                                                           END) END) AS REF_LT                       
              ,CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN A.LDTM_EXCEPT_YN ELSE (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                   <property name="blId" value="A.BL_ID"></property>
                                                                          </include>) END AS LEADTIME_EXCEPT
        FROM (
              SELECT CL.*
                    ,IFNULL((SELECT OPRT_ID
                               FROM TB_SMT_BK_EXPND SBK
                              WHERE SBK.SHIPLN_BKNG_NO = CL.SHIPLN_BKNG_NO 
                                AND SBK.DEL_YN = 'N'
                                AND SBK.OPRT_ID IS NOT NULL 
                                AND SBK.BKNG_STAT_CD IN ('N','F')
                              LIMIT 1), (SELECT OPRT_ID
                                           FROM TB_SMT_BK_EXPND SBK
                                          WHERE SBK.BKNG_ORD_NO = CL.RPRS_REF_NO
                                            AND SBK.DEL_YN = 'N'
                                            AND SBK.OPRT_ID IS NOT NULL
                                            AND SBK.BKNG_STAT_CD IN ('N','F')
                                          LIMIT 1)) AS SBK_OPRT_ID
                    ,(SELECT X1.ENG_EMP_NM 
                        FROM TB_COM_EMP X1 
                       WHERE X1.EMPNO = CL.ORD_OFCR_EMPNO ) AS ORD_OFCR_EMPNM
                    ,(SELECT X1.ENG_EMP_NM 
                        FROM TB_COM_EMP X1 
                       WHERE X1.EMPNO = CL.SALES_OFCR_EMPNO ) AS SALES_OFCR_EMPNM
                    ,IFNULL((SELECT X1.ENG_EMP_NM 
                               FROM TB_COM_EMP X1 
                              WHERE X1.EMPNO = CL.RSTR_ID ), CL.RSTR_ID) AS RSTR_EMPNM                
                    ,(SELECT EMAIL_ADDR 
                        FROM TB_COM_EMP
                       WHERE EMPNO = CL.OFCR_EMPNO
                       LIMIT 1) AS OFCR_EMAIL_ADDR
                    ,(SELECT EMAIL_ADDR 
                        FROM TB_COM_EMP
                       WHERE EMPNO = CL.ORD_OFCR_EMPNO
                       LIMIT 1) AS ORD_OFCR_EMAIL_ADDR
                    ,(SELECT EMAIL_ADDR 
                        FROM TB_COM_EMP
                       WHERE EMPNO = CL.SALES_EMP_EMPNO
                       LIMIT 1) AS SALES_EMP_EMAIL_ADDR
                    ,(SELECT EMAIL_ADDR 
                        FROM TB_COM_EMP
                       WHERE EMPNO = CL.SALES_OFCR_EMPNO
                       LIMIT 1) AS SALES_OFCR_EMAIL_ADDR
                    ,(SELECT EMAIL_ADDR 
                        FROM TB_COM_EMP
                       WHERE EMPNO = CL.RSTR_ID
                       LIMIT 1) AS RSTR_EMAIL_ADDR
                    ,IFNULL((SELECT ED.DTL_CD_NM
                               FROM TB_COM_ETC_CD ED
                              WHERE ED.CLAS_CD = '1448'
                                AND ED.USE_YN = 'Y'
                                AND CL.GOFF_AREA_NM LIKE '%'||ED.DTL_CD_NM||'%'
                              LIMIT 1), CL.GOFF_AREA_NM) AS GOFF_AREA_CD
                    ,(CASE WHEN CL.ONBR_CLOS_YN = 'Y' THEN CL.STD_ETA_YMD
                           ELSE ( CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                      <property name="blId" value="CL.BL_ID"></property>
                                             </include>) = 'Y' OR IFNULL(CL.POL_POD_LDTM_DCNT, 0) = 0 THEN ''
                                       ELSE (STR_TO_DATE(CL.ONBR_YMD, '%Y%m%d') + IFNULL(CL.POL_POD_LDTM_DCNT, 0))
                                  END )
                      END) AS STD_DATE
                    ,(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                          <property name="blId" value="CL.BL_ID"></property>
                                 </include>) = 'Y' OR IFNULL(CL.POL_POD_LDTM_DCNT, 0) = 0 THEN ''
                           ELSE (STR_TO_DATE(CL.ONBR_YMD, '%Y%m%d') + IFNULL(CL.POL_POD_LDTM_DCNT, 0) - STR_TO_DATE(CL.ARR_YMD, '%Y%m%d'))
                      END) AS DATE_GAP
                    ,(CASE WHEN CL.ONBR_CLOS_YN = 'Y' THEN CL.HIST_ETA_YMD ELSE ( CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                                                                                      <property name="blId" value="CL.BL_ID"></property>
                                                                                             </include>) = 'Y' OR IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN ''
                                                                                       ELSE (STR_TO_DATE(CL.ONBR_YMD, '%Y%m%d') + IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0)) END)
                      END) AS HIS_DATE
                    ,(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
                                          <property name="blId" value="CL.BL_ID"></property>
                                 </include>) = 'Y' OR IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN 0
                           ELSE (STR_TO_DATE(CL.ONBR_YMD, '%Y%m%d') + IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0) - STR_TO_DATE(CL.ARR_YMD, '%Y%m%d'))
                      END) AS HIS_DATE_GAP
                FROM (
                      SELECT 'N'   AS CHK
                            ,B.SMT_NO                          /* so번호 */
                            ,B.EO_NO                          /* eo번호 */
                            ,A.BL_NO                          /* hbl번호 */
                            ,A.SR_NO
                            ,A.MBL_NO
                            ,A.WGT_CLOS_YN
                            ,IFNULL(A.ONBR_CLOS_YN, 'N') AS ONBR_CLOS_YN                  /* 출항마감여부 */
                            ,IFNULL(A.ARR_CLOS_YN, 'N') AS ARR_CLOS_YN                   /*입항마감여부 */
                            ,A.EXP_CC_RQST_YN                 /* 수출통관요청여부 */
                            ,A.IMP_CC_RQST_YN                 /* 수입통관요청여부 */
                            ,A.BL_SPR_CD                      /* bl type, bl구분코드(BL구분(M : MBL, H:HBL, D:DBL, C:코로드BL)) */
                            ,(SELECT DTL_CD_NM
                                FROM TB_COM_ETC_CD
                               WHERE CLAS_CD = '0055'
                                 AND DTL_CD  = A.BL_SPR_CD
                                 AND USE_YN ='Y') AS BL_SPR_CD_NM
                            ,A.LADG_TYPE_CD
                            ,(SELECT DTL_CD_NM
                                FROM TB_COM_ETC_CD
                               WHERE CLAS_CD = '0064'
                                 AND DTL_CD  = A.LADG_TYPE_CD
                                 AND USE_YN ='Y') AS LADG_TYPE_CD_NM
                            ,A.ONBR_YMD
                            ,A.ARR_YMD
                            /* TODO : VW_VM_SO_TRCKG
                            ,(SELECT FC_FW_GET_BL_TRACK_DT(A.BL_ID, 'POD_ATA', 'YMD') FROM DUAL) AS ETA_YMD
                            */
                            ,'' AS ETA_YMD
                            ,A.CARR_GRP_CD                    /* 운송사그룹코드 */
                            ,A.CARR_NM                        /* 운송사명 */
                            ,D.CARR_CD
                            ,(SELECT BIZPTNR_ENG_NM  
                                FROM TB_COM_BIZPTNR 
                               WHERE BIZPTNR_CD = D.CARR_CD) AS CARR_CD_NM
                            ,D.AGNT_CD
                            ,(SELECT BIZPTNR_ENG_NM  
                                FROM TB_COM_BIZPTNR 
                               WHERE BIZPTNR_CD = D.AGNT_CD) AS AGNT_CD_NM
                            ,A.FLT_VSL_NM
                            ,A.VOYAGE    
                            ,A.POR_NM    
                            ,A.POL_NM    
                            ,A.POD_NM    
                            ,A.PDEL_NM   
                            ,A.FDEST_NM  
                            ,A.SHPP_CD   
                            ,A.CNEE_CD   
                            ,A.NTPR_CD   
                            ,A.SHPP_NM   
                            ,A.CNEE_NM   
                            ,A.NTPR_NM   
                            ,A.SELL_GWT  
                            ,A.SELL_CBM  
                            ,A.PKG_QTY   
                            ,A.PKG_UNIT_CD
                            ,(SELECT DTL_CD_NM
							    FROM TB_COM_ETC_CD
							   WHERE CLAS_CD = '0134'
							     AND DTL_CD  = A.PKG_UNIT_CD
								 AND USE_YN ='Y') AS PKG_UNIT_CD_NM
                            ,A.CARGO_TYPE_CD                  /* 화물유형코드   */
                            ,(SELECT DTL_CD_NM
                                FROM TB_COM_ETC_CD
                               WHERE CLAS_CD = '0077'
                                 AND DTL_CD  = A.CARGO_TYPE_CD
                                 AND USE_YN ='Y') AS CARGO_TYPE_CD_NM
                            ,A.RPRS_REF_NO                    /* 대표참조번호   */
                            ,(SELECT (SELECT X1.CORP_ACRN_NM5 FROM TB_COM_CORP X1 WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
                                FROM TB_SMT_INTG_TASK_DEPT T
                               WHERE B.EO_NO = T.EO_NO
                                 AND T.TASK_SPR_CD = 'EXP'
                                 AND T.DEL_YN = 'N'
                               LIMIT 1) AS ORGIN_PTNR
                            ,(SELECT (SELECT X1.CORP_ACRN_NM5 FROM TB_COM_CORP X1 WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
                                FROM TB_SMT_INTG_TASK_DEPT T
                               WHERE B.EO_NO = T.EO_NO
                                 AND T.TASK_SPR_CD = 'TRD'
                                 AND T.DEL_YN = 'N'
                               LIMIT 1) AS THIRD_PTNR
                            ,(SELECT (SELECT X1.CORP_ACRN_NM5 FROM TB_COM_CORP X1 WHERE X1.CORP_CD = T.EXCT_BIZPTNR_CD)
                                FROM TB_SMT_INTG_TASK_DEPT T
                               WHERE B.EO_NO = T.EO_NO
                                 AND T.TASK_SPR_CD = 'IMP'
                                 AND T.DEL_YN = 'N'
                               LIMIT 1) AS ARR_PTNR
                            ,CASE WHEN (SELECT T.REMARK
                                          FROM NFINF.TB_FWD_INT5040 T
                                         WHERE T.HBL_NO = A.BL_NO
                                           AND T.RES_SEQ = (SELECT S.RES_SEQ
                                                              FROM NFINF.TB_FWD_INT5040 S
                                                             WHERE S.HBL_NO = T.HBL_NO
                                                             LIMIT 1)
                                         LIMIT 1) IS NULL THEN 'Y' ELSE 'N' END AS MFCS_ERR_YN
                            ,(SELECT (SELECT Y.DTL_CD_NM FROM TB_COM_ETC_CD Y WHERE Y.CLAS_CD = '0217' AND Y.DTL_CD = T.STATUS)
                                FROM NFINF.TB_FWD_INT5040 T
                               WHERE T.HBL_NO = A.BL_NO
                                 AND T.RES_SEQ = (SELECT S.RES_SEQ
                                                    FROM NFINF.TB_FWD_INT5040 S
                                                   WHERE S.HBL_NO = T.HBL_NO
                                                   LIMIT 1)
                               LIMIT 1) AS MFCS_STATUS
                            ,(SELECT T.REMARK
                                FROM NFINF.TB_FWD_INT5040 T
                               WHERE T.HBL_NO = A.BL_NO
                                 AND T.RES_SEQ = (SELECT S.RES_SEQ
                                                    FROM NFINF.TB_FWD_INT5040 S
                                                   WHERE S.HBL_NO = T.HBL_NO
                                                   LIMIT 1)
                               LIMIT 1) AS MFCS_ERROR
                            ,A.BL_ID                          /* BLID */
                            ,D.INTG_TASK_NO                   /* 통합역할번호 */
                            ,D.TASK_SPR_CD                    /* 역할구분코드 :0031 */
                            ,(SELECT DTL_CD_NM
                                FROM TB_COM_ETC_CD
                               WHERE CLAS_CD = '0031'
                                 AND DTL_CD  = D.TASK_SPR_CD
                                 AND USE_YN ='Y') AS TASK_SPR_CD_NM
                            ,A.UPDR_ID
                            ,A.UPD_DT
                            ,A.EXCT_SPR_CD
                            ,'' AS STAT_CD
                            ,'' AS ID_TYPE
                            ,'' AS PREFIX
                            ,'' AS CLOSE_YN
                            ,'' AS CLOS_YN
                            ,A.INCOT_CD
                            ,A.RPRS_ITEM_NM
                            ,D.OFCR_EMPNO
                            ,CASE WHEN EXISTS (SELECT 1
                                                 FROM TB_COM_EMP 
                                                WHERE EMP_NM = 'RPA'
                                                  AND USE_YN = 'Y'
                                                  AND EMPNO = IFNULL((SELECT UPDR_ID 
                                                                        FROM TB_FWD_BL_LOG BL_LOG
                                                                       WHERE BL_ID = A.BL_ID 
                                                                         AND ONBR_CLOS_YN = A.ONBR_CLOS_YN 
                                                                         AND BL_STAT_CD = CASE WHEN #{closeType} = 'OC' THEN '300'
                                                                                               WHEN #{closeType} = 'AC' THEN '320'
                                                                                               WHEN #{closeType} = 'TC' THEN '300'
                                                                                               ELSE '300'
                                                                                          END
                                                                         AND DEL_YN = 'N'
                                                                       LIMIT 1), 'X')
                                               ) THEN 'Y' ELSE 'N' END AS RPA_YN
                            ,(SELECT X1.ENG_EMP_NM
                                FROM TB_COM_EMP X1
                               WHERE X1.EMPNO = D.OFCR_EMPNO) AS OFCR_EMPNM
                            ,E.SALES_EMP_EMPNO
                            ,IFNULL(F.ARR_CLOS_AUTO_APLY_YN, 'N') AS ARR_CLOS_AUTO_APLY_YN
                            ,(SELECT X1.ENG_EMP_NM
                                FROM TB_COM_EMP X1
                               WHERE X1.EMPNO = E.SALES_EMP_EMPNO) AS SALES_EMP_EMPNM
                            ,CASE WHEN A.BL_SWITCH_YN = 'Y' THEN SUBSTR((SELECT MBL_ID
                                                                           FROM TB_FWD_BL A
                                                                          WHERE DEL_YN  = 'N'
                                                                            AND IFNULL(A.BL_SWITCH_YN, 'N') = 'N'
                                                                            AND BL_ID = (SELECT ORIGN_BL_ID
                                                                                           FROM TB_FWD_BL
                                                                                          WHERE BL_ID = A.BL_ID )), 0, 100)
                                  ELSE A.MBL_ID END AS MBL_ID
                        
                            ,IFNULL(A.BL_SWITCH_YN, 'N') AS BL_SWITCH_YN
                            ,IFNULL(C.SWT_BL_YN, 'N') AS SWT_BL_YN
                            ,(SELECT COUNT(1)
                                FROM TB_FWD_BL_ITEM_MPNG X
                          INNER JOIN TB_SMT_INTG_ITEM    T
                                  ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                               WHERE X.BL_ID = A.BL_ID
                                 AND X.DEL_YN = 'N'
                                 AND T.DEL_YN = 'N'
                                 AND T.CNTR_YN = 'Y'
                                 AND X.MPNG_KIND_CD = 'OMI'
                                 AND T.CNTR_SIZE_CD = '20'
                                 AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') CNTR_SIZE20
                            ,(SELECT COUNT(1)
                                FROM TB_FWD_BL_ITEM_MPNG X
                          INNER JOIN TB_SMT_INTG_ITEM    T
                                  ON X.INTG_ITEM_NO = T.INTG_ITEM_NO
                               WHERE X.BL_ID = A.BL_ID
                                 AND X.DEL_YN = 'N'
                                 AND T.DEL_YN = 'N'
                                 AND T.CNTR_YN = 'Y'
                                 AND X.MPNG_KIND_CD = 'OMI'
                                 AND T.CNTR_SIZE_CD = '40'
                                 AND IFNULL(T.FULL_PRTL_SPR_CD, 'F') = 'F') CNTR_SIZE40
                            ,SUBSTR((<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetMblTaskNo">
                                         <property name="blId" value="A.BL_ID"></property>
                                         <property name="intgTaskNo" value="D.INTG_TASK_NO"></property>
                                     </include>), 0, 100) AS MBL_INTG_TASK_NO
                            ,(SELECT X.SMT_NO
                                FROM TB_FWD_BL X
                               WHERE X.BL_ID = (CASE WHEN IFNULL(A.BL_SWITCH_YN, 'N') = 'Y' THEN (SELECT MBL_ID
                                                                                                    FROM TB_FWD_BL A
                                                                                                   WHERE DEL_YN  = 'N'
                                                                                                     AND IFNULL(A.BL_SWITCH_YN, 'N') = 'N'
                                                                                                     AND BL_ID = (SELECT ORIGN_BL_ID
                                                                                                                    FROM TB_FWD_BL
                                                                                                                   WHERE BL_ID = A.MBL_ID ))
                                                     ELSE A.MBL_ID END)) AS MBL_SMT_NO
                            ,C.ORD_SPR_CD
                            ,(SELECT DTL_CD_NM
                                FROM TB_COM_ETC_CD
                               WHERE CLAS_CD = '0514'
                                 AND DTL_CD  = (<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetSwitchInfo">
                                                   <property name="blId" value="A.BL_ID"></property>
                                                </include>)
                                 AND USE_YN ='Y') AS SWITCH_STATUS
                            ,(SELECT X.EXCT_BIZPTNR_CD
                                FROM TB_SMT_INTG_TASK_DEPT X
                               WHERE A.EO_NO = X.EO_NO
                                 AND A.BL_ID = X.CST_BL_ID
                                 AND X.DEL_YN = 'N'
                                 AND X.TASK_SPR_CD = 'IMP'
                               LIMIT 1) AS IMP_CORP_CD
                            ,#{bizptnrCd} AS CORP_CD
                            ,CASE WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'N' THEN 'PROCESSING' WHEN IFNULL(A.ORIGN_PRNT_YN, 'N') = 'Y' THEN 'ISSUED' END AS ISSUED
                            ,IFNULL(A.SPLIT_BL_YN, 'N') AS SPLIT_BL_YN
                            ,(SELECT GROUP_CONCAT(CONCAT(EXP_LICE_NO,  "/")  ORDER BY BL_ID, LICE_SEQ)
                                FROM TB_FWD_BL_EXP_LICE X
                               WHERE A.BL_ID = X.BL_ID
                                 AND X.DEL_YN = 'N') AS EL_NO
                            ,(SELECT CASE WHEN A.ONBR_CLOS_YN = 'Y' THEN 'Y' ELSE (CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END) END
                                FROM TB_FWD_BL_PRT_APRV Y
                          INNER JOIN TB_FWD_BL_PRT_APRV_DTL Z
                                  ON Y.RQST_SEQ = Z.RQST_SEQ
                               WHERE Y.APRV_REQR_ID = #{userId}
                                 AND Y.STEP_CD = '7777'
                                 AND Z.BL_ID = A.BL_ID ) AS BL_PRTN_APRV_YN
                            ,D.EXCT_BIZPTNR_CD AS RSLT_CORP_CD
                            ,'' AS PGM_ID
                            ,(SELECT Z.DEPT_CD
                                FROM TB_COM_EMP Z
                               WHERE Z.EMPNO = #{userId} ) AS USER_DEPT_CD
                            ,(SELECT Z.CORP_CD
                                FROM TB_COM_EMP Z
                               WHERE Z.EMPNO = #{userId} ) AS USER_CORP_CD
                            ,(SELECT B.MGR_EMPNO
                                FROM TB_COM_EMP A
                          INNER JOIN TB_COM_HR_DEPT B
                                  ON A.DEPT_CD = B.DEPT_CD
                               WHERE A.HR_COM_CD = B.HR_COM_CD
                                 AND A.EMPNO = #{userId} ) AS USER_MGR_EMPNO
                            ,A.POR_CD
                            ,A.POL_CD
                            ,A.POD_CD
                            ,A.PDEL_CD
                            ,A.FDEST_CD
                            ,'' ERR_MSG
                            ,A.NON_EXCT_BL_YN
                            ,(SELECT X.DTL_CD_NM
                                FROM TB_COM_ETC_CD X
                               WHERE X.CLAS_CD = '0219'
                                 AND X.DTL_CD = C.ORD_SPR_CD
                                 AND X.USE_YN = 'Y') AS ORD_SPR_NM
                            ,IFNULL(F.TRCKG_AUTO_APLY_YN, 'N') TRCKG_AUTO_APLY_YN
                            ,(SELECT IFNULL(CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END, 'N')
                                FROM TB_FWD_BL AX
                          INNER JOIN TB_SMT_INTG_TASK_DEPT BX
                                  ON AX.BL_ID = BX.CST_BL_ID
                                 AND AX.EO_NO = BX.EO_NO
                          INNER JOIN TB_COM_BIZPTNR_KIND CX
                                  ON BX.CARR_CD = CX.BIZPTNR_CD 
                               WHERE AX.BL_ID = A.BL_ID
                                 AND AX.DEL_YN = 'N'
                                 AND BX.DEL_YN = 'N'
                                 AND BX.TASK_SPR_CD = D.TASK_SPR_CD
                                 AND CX.BIZPTNR_KIND_CD = 'V150')  AS FERRY_CARR_YN
                            ,IFNULL((SELECT CASE WHEN X.OFCR_EMPNO IS NULL OR X.OFCR_EMPNO = '' THEN 'N'
                                                 WHEN X.EXCT_DEPT_CD IS NULL OR X.EXCT_DEPT_CD = '' THEN 'N'
                                                 WHEN X.CARR_CD IS NULL OR X.CARR_CD = '' THEN 'N'
                                                 WHEN X.AGNT_CD IS NULL OR X.AGNT_CD = '' THEN 'N'
                                            ELSE 'Y' END
                                       FROM TB_SMT_INTG_TASK_DEPT X
                                      WHERE X.INTG_TASK_NO = (<include refid="fwd.common.fwdFuncInclude.fwdFcFwGetMblTaskNo">
										                          <property name="blId" value="A.BL_ID"></property>
										                          <property name="intgTaskNo" value="D.INTG_TASK_NO"></property>
										                      </include>)
										AND X.DEL_YN = 'N'), 'Y') AS MBL_CLOS_POSB_YN
                            /*
                            ,(SELECT POL_POD_LDTM_DCNT
                              FROM   TB_VM_TRCKG_ROUT_MSTR
                              WHERE  POL_CD = A.POL_CD
                              AND    POD_CD = A.POD_CD
                              AND    CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                              AND    DEL_YN = 'N'
                              AND    ROWNUM = 1
                              ) AS POL_POD_LDTM_DCNT
                            */
                            ,'' AS POL_POD_LDTM_DCNT
                            /*
                            ,(SELECT MAX_FRQNY_LDTM_DCNT
                              FROM   TB_VM_TRCKG_ROUT_MSTR
                              WHERE  POL_CD = A.POL_CD
                              AND    POD_CD = A.POD_CD
                              AND    CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                              AND    DEL_YN = 'N'
                              AND    ROWNUM = 1
                              ) AS MAX_FRQNY_LDTM_DCNT
                            */
                            ,'' AS MAX_FRQNY_LDTM_DCNT
                            /*
                            ,(SELECT MSTR_SCHD_APLY_YN
                              FROM   TB_VM_TRCKG_ROUT_MSTR
                              WHERE  POL_CD = A.POL_CD
                              AND    POD_CD = A.POD_CD
                              AND    CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
                              AND    DEL_YN = 'N'
                              AND    ROWNUM = 1
                              ) AS MSTR_SCHD_APLY_YN
                            */
                            ,'' AS MSTR_SCHD_APLY_YN
                            /*
                            , (SELECT TS1_CD
                               FROM TB_VM_TRCKG_ROUT_MSTR AA
                                  , TB_OM_INTG_TASK_DEPT BB
                               WHERE AA.POL_CD = A.POL_CD
                               AND AA.POD_CD = A.POD_CD
                               AND AA.CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(BB.CARR_CD) FROM DUAL)
                               AND AA.DEL_YN = 'N'
                               AND BB.DEL_YN = 'N'
                               AND BB.CST_BL_ID = A.BL_ID
                               AND BB.TASK_SPR_CD = 'EXP'
                               AND ROWNUM = 1) AS ROUT_TS1_CD
                            */
                            ,'' AS ROUT_TS1_CD
                            ,F.TS1_PORT_CD
                            ,(SELECT IFNULL(CASE WHEN COUNT(1) = 0 THEN 'N' ELSE 'Y' END,'N')
                                FROM TB_FWD_BL AX
                          INNER JOIN TB_SMT_INTG_TASK_DEPT BX
                                  ON AX.BL_ID = BX.CST_BL_ID
                                 AND AX.EO_NO = BX.EO_NO
                          INNER JOIN TB_COM_ETC_CD CX
                                  ON BX.CARR_CD = CX.RMK_CONT
                               WHERE AX.BL_ID = A.BL_ID
                                 AND AX.DEL_YN = 'N'
                                 AND BX.DEL_YN = 'N'
                                 AND BX.TASK_SPR_CD = D.TASK_SPR_CD
                                 AND CX.CLAS_CD = '1321'
                                 AND CX.USE_YN = 'Y') AS ARR_DATE_CHK_SKIP_YN
                            ,(SELECT BK.GOFF_AREA_NM
                                FROM TB_SMT_BK_EXPND BK
                               WHERE BK.CORP_CD = #{bizptnrCd}
                                 AND BK.SHIPLN_BKNG_NO = A.SHIPLN_BKNG_NO
                                 AND BK.DEL_YN = 'N'
                               LIMIT 1)  AS GOFF_AREA_NM
                        
                            ,C.ONBR_RQST_YMD  /* 출항요청일자 */
                            ,A.ROUT_SPR_CD
                        
                            ,D.RSLT_DEPT_CD
                            ,(SELECT X1.ACCTG_DEPT_ENG_NM 
                                FROM TB_COM_ACCTG_DEPT  X1
                               WHERE X1.ACCTG_DEPT_CD = D.RSLT_DEPT_CD ) AS RSLT_DEPT_NM
                            ,G.BL_TYPE_CD
                            ,(SELECT X.DTL_CD_NM
                                FROM TB_COM_ETC_CD X
                               WHERE X.CLAS_CD = '1158'
                                 AND X.DTL_CD = G.BL_TYPE_CD
                                 AND X.USE_YN = 'Y') AS BL_TYPE_CD_NM
                            ,A.REG_YMD
                            /*
                            ,IFNULL(F.OPT_TS_YN, CASE WHEN EXISTS (SELECT 1 
                                                                     FROM TB_VM_INTG_EXCEPT_TRCKG AA
                                                                         ,TB_VM_INTG_EXCEPT_MGNT BB 
                                                                         ,TB_VM_SO_TRCKG CC 
                                                                WHERE AA.EXCEPT_NO = BB.EXCEPT_NO
                                                                AND   CC.SO_TRCKG_SEQ = AA.SO_TRCKG_SEQ
                                                                AND   CC.SMT_NO = A.SMT_NO 
                                                                AND   AA.RSTR_ID = 'S-BOOKING BATCH'         
                                                                AND   AA.DEL_YN = 'N'
                                                                AND   BB.DEL_YN = 'N'  
                                                                AND   CC.DEL_YN = 'N' ) THEN 'Y'
                                                    ELSE  F.OPT_TS_YN END) AS OPT_TS_YN
                            */
                            ,'' AS OPT_TS_YN
                            ,A.SHIPLN_BKNG_NO
                            ,C.ORD_OFCR_EMPNO
                            ,C.SALES_OFCR_EMPNO
                            ,A.RSTR_ID 
                            ,F.HIST_ETA_YMD
                            ,F.STD_ETA_YMD
                            ,F.ARRV_PRAR_GAP_DCNT
                            ,F.REF_LDTM_DCNT
                            ,F.LDTM_EXCEPT_YN
                            ,F.ARRV_PRAR_GAP_CLR_NM
                            ,F.ARRV_YMD_CHG_YN
                            ,(SELECT BK.ETA_YMD
                                FROM TB_SMT_BK_EXPND BK
                               WHERE BK.BKNG_ORD_NO = A.RPRS_REF_NO
                                 AND BK.BKNG_STAT_CD = 'F'
                               LIMIT 1
                             ) AS LGC_POD_ETA
                            /*
                            ,CASE WHEN (SELECT COUNT(*) 
                                          FROM TB_COM_BIZPTNR
                                         WHERE BIZPTNR_CD = A.SHPP_CD
                                    CONNECT BY PRIOR BIZPTNR_CD = UPPR_BIZPTNR_CD 
                                    START WITH BIZPTNR_CD = '2000210') > 0 THEN 'Y'
                                  WHEN (SELECT COUNT(*)
                                             FROM TB_CM_BIZPTNR
                                            WHERE BIZPTNR_CD = A.SHPP_CD
                                              AND BIZPTNR_GRP_CD = '1001010') > 0 THEN 'Y'
                                     ELSE 'N'
                                 END AS LGC_YN
                            */
                            ,'' AS LGC_YN
                            ,IFNULL(F.HIST_POD_ETA_YMD, (<include refid="fwd.common.fwdFuncInclude.fwdFcFwHistPodEtaYmd">
                                                                  <property name="blId" value="A.BL_ID"></property>
                                                         </include>))  AS HIST_POD_ETA_YMD
                            ,IFNULL(F.HIST_POD_ETA_YMD_YN , 'N') AS ORG_HIST_POD_ETA_YMD_YN
                            ,IFNULL(F.HIST_POD_ETA_YMD_YN, (CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fwdFcFwHistPodEtaYmd">
                                                                                <property name="blId" value="A.BL_ID"></property>
                                                                       </include>) IS NULL THEN 'Y' ELSE 'N' END)) AS HIST_POD_ETA_YMD_YN
                            ,IFNULL((<include refid="fwd.common.fwdFuncInclude.fwdFcFwHistPodEtaYmd">
                                                                  <property name="blId" value="F.BL_ID"></property>
                                                         </include>), '') AS CUR_HIST_POD_ETA_YMD
            <if test='closeType != null or closeType != "" and closeType == "OC" and scYn == "Y"'>
            </if>
            <if test='scYn == "Y"'>
            </if>
                        FROM TB_FWD_BL             A
                  INNER JOIN TB_FWD_BL_EXPND       F
                          ON A.BL_ID = F.BL_ID
                  INNER JOIN TB_SMT_EO             B
                          ON A.EO_NO = B.EO_NO
                  INNER JOIN TB_SMT_ORD            C
                          ON A.SMT_NO = C.SMT_NO
                  INNER JOIN TB_SMT_INTG_TASK_DEPT D
                          ON A.BL_ID = D.CST_BL_ID
                         AND B.EO_NO = D.EO_NO
             LEFT OUTER JOIN TB_SMT_ORD_SELL_BILG  E
                          ON A.SMT_NO = E.SMT_NO
             LEFT OUTER JOIN TB_FWD_BL_PRT_EXPND   G
                          ON A.BL_ID = G.BL_ID
                       WHERE 1 = 1
                         AND B.DEL_YN = 'N'
                         AND D.DEL_YN = 'N'
                         AND D.EXCT_BIZPTNR_CD   = #{bizptnrCd}
                         AND E.SELL_BIZPTNR_CD   = #{bizptnrCd}
                         AND A.BL_NO IS NOT NULL
                         AND 1 = (CASE WHEN A.BL_SPR_CD = 'H' AND A.BL_SWITCH_YN = 'N' AND A.MBL_ID IS NULL THEN 2 ELSE 1 END)
            <if test='exctSprCd == null or exctSprCd == ""'>
                   AND A.EXCT_SPR_CD = 'OC'
                   AND A.BL_SPR_CD IN ('H', 'D')
            </if>
            <choose>
               <when test="blno != null and blno != '' and noType == 'BL'">
                   AND A.BL_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <when test="blno != null and blno != '' and noType == 'EO'">
                   AND A.EO_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <when test="blno != null and blno != '' and noType == 'SMT'">
                   AND A.SMT_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <when test="blno != null and blno != '' and noType == 'SR'">
                   AND A.SR_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <when test="blno != null and blno != '' and noType == 'MBL'">
                   AND A.MBL_NO
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>                        
               </when>
               <when test="blno != null and blno != '' and noType == 'VSL'">
                   AND A.FLT_VSL_NM IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <when test="blno != null and blno != '' and noType == 'LNBKNG'">
                   AND A.SHIPLN_BKNG_NO IN
                                   <foreach collection="blnoList" item="blno" index="index" separator="," open="(" close=")">
                                            #{blno}
                                   </foreach>
               </when>
               <otherwise>
                 <if test='closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "OC"'>
                   AND C.ORD_SPR_CD IN ('10', '50')
                   AND D.TASK_SPR_CD = 'EXP'
                 </if>
                 <if test='closeYn != null and closeYn != "" and closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "OC"'>
                   AND A.ONBR_CLOS_YN = #{closeYn}
                 </if>
                 <if test='closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "AC"'>
                   AND C.ORD_SPR_CD  = '10'
                   AND 1 = (CASE WHEN A.BL_SPR_CD = 'H' AND D.TASK_SPR_CD = 'IMP' AND IFNULL(A.ONBR_CLOS_YN, 'N') = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'H' AND IFNULL(A.LOCL_PTNR_YN, 'N') = 'Y' AND D.TASK_SPR_CD IN ('EXP', 'IMP') AND A.ONBR_CLOS_YN = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'D' AND IFNULL(A.ONBR_CLOS_YN, 'N') = 'Y' THEN 1
                                 WHEN A.BL_SPR_CD = 'D' AND IFNULL(A.LOCL_PTNR_YN, 'N') = 'Y' AND D.TASK_SPR_CD IN ('EXP', 'IMP') THEN 1
                                 ELSE 2
                            END)
                 </if>
                 <if test='closeYn != null and closeYn != "" and closeTypeCon != null and closeTypeCon != "" and closeTypeCon == "AC"'>
                   AND A.ARR_CLOS_YN = #{closeYn}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "OB"'>
                   AND A.ONBR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "AR"'>
                   AND A.ARR_YMD BETWEEN #{udc_fromToCal_from} AND #{udc_fromToCal_to}
                 </if>
                 <if test='dateType != null and dateType != "" and dateType == "EO"'>
                   AND B.REG_DT BETWEEN STR_TO_DATE(#{udc_fromToCal_from}, '%Y-%m-%d') AND STR_TO_DATE(#{udc_fromToCal_to}, '%Y-%m-%d') + 1
                 </if>
                 <if test='closeType != null and closeType != "" and closeType == "HB" and closeYn == "Y"'>
                   AND (A.BL_NO IS NULL OR A.BL_NO = '')
                 </if>
                 <if test='closeType != null and closeType != "" and closeType == "HB" and closeYn == "N"'>
                   AND A.BL_NO IS NOT NULL
                 </if>
                 <if test="blSprCd != null and blSprCd != ''">
                   AND A.BL_SPR_CD = #{blSprCd}
                 </if>
                 <if test="exctSprCd != null and exctSprCd != ''">
                   AND A.EXCT_SPR_CD = #{exctSprCd}
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "PO"'>
                   AND A.POR_CD = #{porCd}
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POR_CD
                                  AND X.NATN_CD = #{porCd})
                 </if>
                 <if test='porCd != null and porCd != "" and porType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POR_CD, 1, 2)
                                  AND X.REGN_CD = #{porCd})
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "PO"'>
                   AND A.POL_CD = #{polCd}
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POL_CD
                                  AND X.NATN_CD = #{polCd})
                 </if>
                 <if test='polCd != null and polCd != "" and polType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POL_CD, 1, 2)
                                  AND X.REGN_CD = #{polCd})
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "PO"'>
                   AND A.POD_CD = #{podCd}
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.POD_CD
                                  AND X.NATN_CD = #{podCd})
                 </if>
                 <if test='podCd != null and podCd != "" and podType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.POD_CD, 1, 2)
                                  AND X.REGN_CD = #{podCd})
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "PD"'>
                   AND A.PDEL_CD = #{pdelCd}
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "NA"'>
                   AND EXISTS (SELECT  1
                                 FROM TB_COM_LOC X
                                WHERE X.USE_YN  = 'Y'
                                  AND X.LOC_CD  = A.PDEL_CD
                                  AND X.NATN_CD = #{pdelCd})
                 </if>
                 <if test='pdelCd != null and pdelCd != "" and pdelType == "RG"'>
                   AND EXISTS (SELECT 1
                                 FROM TB_COM_LOC X
                                WHERE 1=1
                                  AND X.USE_YN = 'Y'
                                  AND X.LOC_CD = SUBSTR(A.PDEL_CD, 1, 2)
                                  AND X.REGN_CD = #{pdelCd})
                 </if>
                 <if test='lnCd != null and lnCd != ""'>
                   AND D.CARR_CD = #{lnCd}
                 </if>
                 <if test='agntCd != null and agntCd != ""'>
                   AND D.AGNT_CD = #{agntCd}
                 </if>
                 <if test='shprCd != null and shprCd != ""'>
                   AND A.SHPP_CD = #{shprCd}
                 </if>
                 <if test='cneeCd != null and cneeCd != ""'>
                   AND A.CNEE_CD = #{cneeCd}
                 </if>
                 <if test='ntprCd != null and ntprCd != ""'>
                   AND A.NTPR_CD = #{ntprCd}
                 </if>
                 <if test='refno != null and refno != ""'>
                   AND EXISTS (SELECT 1
                                 FROM TB_FWD_INTG_REF_NO   X
                                WHERE X.DEL_YN = 'N'
                                  AND X.INTG_KEY_ID = A.BL_ID
                                  AND X.REF_NO_SPR_CD = IFNULL(#{refnoType}, X.REF_NO_SPR_CD)
                                  AND X.REF_NO IN  <foreach collection="refnoList" item="refno" index="index" separator="," open="(" close=")">
                                                            #{refno}
                                                   </foreach>)
                 </if>
                 <if test='blSwitchYn != null and blSwitchYn != ""'>
                   AND A.BL_SWITCH_YN = #{blSwitchYn}
                 </if>
                 <if test='oblYn != null and oblYn != ""'>
                   AND IFNULL(A.ORIGN_PRNT_YN, 'N') = #{oblYn}
                 </if>
                 <if test='loadType != null and loadType != ""'>
                   AND A.LADG_TYPE_CD = #{loadType}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "IT"'>
                   AND A.RSTR_ID = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "OI"'>
                   AND D.OFCR_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "SI"'>
                   AND E.SALES_EMP_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "OR"'>
                   AND C.ORD_OFCR_EMPNO = #{operationId}
                 </if>
                 <if test='operationId != null and operationId != "" and idType == "SL"'>
                   AND C.SALES_OFCR_EMPNO = #{operationId}
                 </if>
               </otherwise>
            </choose>
               ) CL
          WHERE 1 = 1
          <if test='cntrLdngYn != null and cntrLdngYn != "" and cntrLdngYn == "Y"'>
            AND CNTR_LDNG_YN = 'Y'
          </if>
          <if test='cntrLdngYn != null and cntrLdngYn != "" and cntrLdngYn == "N"'>
            AND CNTR_LDNG_YN = 'N'
          </if>
          <if test='rpaTargetYn != null and rpaTargetYn != "" and rpaTargetYn == "Y"'>
            AND RPA_TARGET_YN = 'Y'
          </if>
          <if test='rpaTargetYn != null and rpaTargetYn != "" and rpaTargetYn == "N"'>
            AND RPA_TARGET_YN = 'N'
          </if>
       ORDER BY CL.EXCT_SPR_CD, CL.ONBR_YMD, CL.REG_YMD
            ) A
    </select>
    
    <!-- 자동수익인식  목록 조회 -->
    <select id="selectAutoRevnRcgnInfo" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectAutoRevnRcgnInfo */
	    SELECT A.EXCT_DEPT_CD
	          ,A.OFCR_EMPNO
	          ,A.PTNR_CD
	      FROM TB_FWD_REVN_RCGN_EXCEPT A
	     WHERE A.EXCEPT_SEQ = CAST(#{exceptSeq} AS UNSIGNED)
    </select>
    
    <!-- 리드타임 정보 업데이트  -->
    <update id="updateLdtmInfo"  parameterType="dataItem" >
       /* fwd.document.fwdBlClosMgnt.updateLdtmInfo */
       INSERT INTO TB_FWD_BL_EXPND (
                   BL_ID
                  ,HIST_ETA_YMD
                  ,STD_ETA_YMD
                  ,ARRV_PRAR_GAP_DCNT
                  ,REF_LDTM_DCNT
                  ,LDTM_EXCEPT_YN
                  ,ARRV_PRAR_GAP_CLR_NM
                  ,UPDR_ID
                  ,UPD_DT
                  ,RSTR_ID
                  ,REG_DT
       )
       SELECT *
         FROM (
		       SELECT A.BL_ID
		             ,A.HIS_DATE
		             ,A.STD_DATE
		             ,(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
		                                   <property name="blId" value="A.BL_ID"></property>
		                          </include>) = 'Y' THEN 0
		                    ELSE (CASE WHEN ABS(IFNULL(A.DATE_GAP,0)) > ABS(IFNULL(A.HIS_DATE_GAP,0)) THEN DATE_GAP
		                               WHEN ABS(IFNULL(A.DATE_GAP,0)) <![CDATA[<]]> ABS(IFNULL(A.HIS_DATE_GAP,0)) THEN HIS_DATE_GAP
		                               WHEN IFNULL(A.DATE_GAP,0) > IFNULL(A.HIS_DATE_GAP,0)           THEN DATE_GAP
		                               ELSE IFNULL(A.HIS_DATE_GAP, 0) END) END) AS ETA_GAP
		             ,(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
		                                   <property name="blId" value="A.BL_ID"></property>
		                          </include>) = 'Y' THEN 0
		                    ELSE (STR_TO_DATE(A.ONBR_YMD, '%Y%m%d') + IFNULL((CASE WHEN ABS(IFNULL(A.DATE_GAP, 0)) > ABS(IFNULL(A.HIS_DATE_GAP, 0)) THEN DATE_GAP
		                                                                          WHEN ABS(IFNULL(A.DATE_GAP, 0)) <![CDATA[<]]> ABS(IFNULL(A.HIS_DATE_GAP, 0)) THEN HIS_DATE_GAP
		                                                                          WHEN IFNULL(A.DATE_GAP, 0) > IFNULL(A.HIS_DATE_GAP, 0) THEN DATE_GAP
		                                                                     ELSE IFNULL(A.HIS_DATE_GAP, 0) END),0) - STR_TO_DATE(A.ONBR_YMD, '%Y%m%d'))
		               END) AS REF_LT
		             ,(<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
		                        <property name="blId" value="A.BL_ID"></property>
		               </include>) AS LEADTIME_EXCEPT
		             ,(CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
		                                   <property name="blId" value="A.BL_ID"></property>
		                          </include>) = 'Y' THEN 'WHITE'
		                    ELSE ( CASE WHEN GREATEST(ABS(IFNULL(A.DATE_GAP, 0)), ABS(IFNULL(A.HIS_DATE_GAP,0))) >= 3 THEN 'RED'
		                                WHEN GREATEST(ABS(IFNULL(A.DATE_GAP, 0)), ABS(IFNULL(A.HIS_DATE_GAP,0))) >= 2 THEN 'YELLOW'
		                                ELSE 'WHITE' END) END) AS ETA_GAP_COLOR
		             ,#{userId} AS UPDR_ID
		             ,NOW() AS UPD_DT
		             ,#{userId} AS RSTR_ID
		             ,NOW() AS REG_DT
		         FROM (
				       SELECT CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
				                                  <property name="blId" value="CL.BL_ID"></property>
				                         </include>) = 'Y' OR IFNULL(CL.POL_POD_LDTM_DCNT, 0) = 0 THEN ''
				                   ELSE DATE_FORMAT(STR_TO_DATE(CL.ONBR_YMD , '%Y%m%d') + IFNULL(CL.POL_POD_LDTM_DCNT, 0), '%Y-%m-%d')
				              END AS STD_DATE
				             ,CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
				                                  <property name="blId" value="CL.BL_ID"></property>
				                         </include>) = 'Y' OR IFNULL(CL.POL_POD_LDTM_DCNT, 0) = 0 THEN ''
				                   ELSE DATEDIFF(DATE_FORMAT(STR_TO_DATE(CL.ONBR_YMD , '%Y%m%d') + IFNULL(CL.POL_POD_LDTM_DCNT, 0), '%Y-%m-%d'), STR_TO_DATE(CL.ARR_YMD, '%Y%m%d')) 
				              END AS DATE_GAP
				             ,CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
				                                  <property name="blId" value="CL.BL_ID"></property>
				                         </include>) = 'Y' OR IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN ''
				                   ELSE DATE_FORMAT(STR_TO_DATE(CL.ONBR_YMD , '%Y%m%d') + IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0), '%Y-%m-%d')
				              END AS HIS_DATE
				             ,CASE WHEN (<include refid="fwd.common.fwdFuncInclude.fcFwRefLeadtimeExcept">
				                                  <property name="blId" value="CL.BL_ID"></property>
				                         </include>) = 'Y' OR IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0) = 0 THEN ''
				                   ELSE DATEDIFF(DATE_FORMAT(STR_TO_DATE(CL.ONBR_YMD , '%Y%m%d') + IFNULL(CL.MAX_FRQNY_LDTM_DCNT, 0), '%Y-%m-%d'), STR_TO_DATE(CL.ARR_YMD, '%Y%m%d')) 
				              END AS HIS_DATE_GAP
				             ,CL.BL_ID  
				             ,CL.ONBR_YMD 
				             ,CL.ARR_YMD
				             ,CL.BL_NO
				             ,CL.MBL_NO
				             ,CL.SMT_NO
				             ,CL.ONBR_CLOS_YN
				         FROM (
						       SELECT A.SMT_NO                          /* so번호 */
						             ,A.EO_NO                          /* eo번호 */
						             ,A.BL_NO                          /* hbl번호 */
						             ,A.MBL_NO
						             ,IFNULL(A.ONBR_CLOS_YN, 'N') AS ONBR_CLOS_YN                  /* 출항마감여부 */
						             ,IFNULL(A.ARR_CLOS_YN, 'N') AS ARR_CLOS_YN                   /*입항마감여부 */
						             ,A.ONBR_YMD                       /* 출항일자 */
						             ,A.ARR_YMD                        /* 입항일자 */
						             /*,TODO VW_VM_SO_TRCKG (SELECT FC_FW_GET_BL_TRACK_DT(A.BL_ID, 'POD_ATA', 'YMD') FROM DUAL) AS ETA_YMD*/
						             ,'' AS ETA_YMD
						             ,A.BL_ID                          /* BLID */
						             ,A.MBL_ID
						             ,A.BL_SPR_CD
						             ,D.INTG_TASK_NO                   /* 통합역할번호 */
						             ,D.TASK_SPR_CD                    /* 역할구분코드 :0031 */
						             /* TODO TB_VM_TRCKG_ROUT_MSTR
						             ,(SELECT POL_POD_LDTM_DCNT
						                 FROM TB_VM_TRCKG_ROUT_MSTR
						                WHERE POL_CD = A.POL_CD
						                  AND POD_CD = A.POD_CD
						                  AND CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
						                  AND DEL_YN = 'N'
						                  AND ROWNUM = 1) AS POL_POD_LDTM_DCNT
						             */
						             ,0 AS POL_POD_LDTM_DCNT
						             /* TODO TB_VM_TRCKG_ROUT_MSTR
						             ,(SELECT NVL(OTD15_LDTM_DCNT, MAX_FRQNY_LDTM_DCNT)
						                 FROM TB_VM_TRCKG_ROUT_MSTR
						                WHERE POL_CD = A.POL_CD
						                  AND POD_CD = A.POD_CD
						                  AND CARR_CD =  (SELECT FC_CM_GET_BIZPTNR_GRP_CD(D.CARR_CD) FROM DUAL)
						                  AND DEL_YN = 'N'
						                  AND ROWNUM = 1) AS MAX_FRQNY_LDTM_DCNT
						              */
						             ,0 AS MAX_FRQNY_LDTM_DCNT
						         FROM TB_FWD_BL A
						   INNER JOIN TB_FWD_BL_EXPND F
						           ON A.BL_ID = F.BL_ID
						   INNER JOIN TB_SMT_ORD     C
						           ON A.SMT_NO = C.SMT_NO
						   INNER JOIN TB_SMT_INTG_TASK_DEPT D
						           ON A.EO_NO = D.EO_NO
						          AND A.BL_ID = D.CST_BL_ID
						          AND D.DEL_YN = 'N'
						        WHERE 1 = 1   
						          AND A.EXCT_SPR_CD = 'OC'              /*실행영역코드(해상:OC, 항공:AR, 특송:EX) */
						          AND A.BL_SPR_CD IN ('H', 'D')         /*bl구분코드(0055) */                    
						          AND A.DEL_YN = 'N'                    /*삭제여부 */
						          AND A.BL_NO IS NOT NULL
						          AND 1 = (CASE WHEN A.BL_SPR_CD = 'H' AND A.BL_SWITCH_YN = 'N' AND A.MBL_ID IS NULL THEN 2 ELSE 1 END)
						          AND C.ORD_SPR_CD IN ('10', '50')
						          AND D.TASK_SPR_CD = 'EXP' 
						          AND A.BL_ID = #{blId}
						          AND D.EXCT_BIZPTNR_CD = #{corpCd} ) CL
		              ) A
              ) UPD_INFO
            ON DUPLICATE KEY
               UPDATE HIST_ETA_YMD = UPD_INFO.HIS_DATE
                     ,STD_ETA_YMD = UPD_INFO.STD_DATE
                     ,ARRV_PRAR_GAP_DCNT = UPD_INFO.ETA_GAP
                     ,REF_LDTM_DCNT = UPD_INFO.REF_LT
                     ,LDTM_EXCEPT_YN = UPD_INFO.LEADTIME_EXCEPT
                     ,ARRV_PRAR_GAP_CLR_NM = UPD_INFO.ETA_GAP_COLOR
                     ,UPDR_ID = #{userId}
                     ,UPD_DT = NOW()
                     ,RSTR_ID = #{userId}
                     ,REG_DT = NOW()
    </update>
    
    <!-- 2021.11.24 김정숙    Hbl List 대용량 엑셀다운 -->
    <select id="selectSeaHblListExcelDown" parameterType="dataItem" resultType="dataItem">
        /* fwd.document.fwdBlClosMgnt.selectSeaHblListExcelDown */
        SELECT LPAD(IFNULL(MAX(FILE_SEQ), 0) + 1, 6, '0') AS FILE_SEQ
          FROM TB_SEA_UPLOAD_TN_SCHEDULE
    </select>
    
</mapper>
